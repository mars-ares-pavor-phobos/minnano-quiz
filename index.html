<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minna no Nihongo Vocabulary Quiz</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700;900&family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;800;900&display=swap" rel="stylesheet">

    <style>
        
        :root {
            --bg-primary: #faf6f1;
            --bg-secondary: #f0ebe4;
            --bg-tertiary: #e5ded5;
            --card-bg: rgba(255,255,255,0.78);
            --card-bg-elevated: rgba(255,255,255,0.55);
            --card-shadow: 0 1px 3px rgba(139,115,85,0.04), 0 8px 32px rgba(139,115,85,0.08), 0 20px 48px rgba(139,115,85,0.06);
            --card-shadow-hover: 0 4px 16px rgba(139,115,85,0.1), 0 24px 64px rgba(139,115,85,0.16);
            --card-border: rgba(180,160,130,0.15);
            --card-glow: rgba(201,123,123,0.06);
            --accent: #c4736e;
            --accent-light: #f0d0cd;
            --accent-subtle: rgba(196,115,110,0.06);
            --accent-hover: #b5605b;
            --accent-glow: rgba(196,115,110,0.22);
            --accent-deep: #a85550;
            --success: #5a9e6f;
            --success-light: #dff0e4;
            --success-bg: #f0f8f2;
            --success-glow: rgba(90,158,111,0.2);
            --warning: #c49a3c;
            --warning-light: #fef8e5;
            --error: #c95050;
            --error-light: #fde8e8;
            --error-bg: #fef5f5;
            --text-primary: #2c2419;
            --text-secondary: #6b5e50;
            --text-tertiary: #a09686;
            --text-inverse: #ffffff;
            --divider: rgba(0,0,0,0.05);
            --focus-ring: rgba(196,115,110,0.3);
            --overlay: rgba(44,36,25,0.5);
            --font-jp: 'Zen Maru Gothic', 'Noto Sans JP', sans-serif;
            --font-ui: 'Outfit', sans-serif;
            --font-display: 'Playfair Display', serif;
            --radius-sm: 14px;
            --radius-md: 18px;
            --radius-lg: 24px;
            --radius-xl: 28px;
            --transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-fast: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-spring: all 0.55s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            --glass-blur: blur(24px);
            --glass-border: 1px solid rgba(255,255,255,0.4);
        }

        [data-theme="dark"] {
            --bg-primary: #100e0b;
            --bg-secondary: #1a1714;
            --bg-tertiary: #22201c;
            --card-bg: rgba(30,26,22,0.88);
            --card-bg-elevated: rgba(40,35,30,0.75);
            --card-shadow: 0 2px 8px rgba(0,0,0,0.3), 0 12px 44px rgba(0,0,0,0.45);
            --card-shadow-hover: 0 4px 16px rgba(0,0,0,0.45), 0 24px 64px rgba(0,0,0,0.55);
            --card-border: rgba(255,220,180,0.07);
            --card-glow: rgba(212,144,143,0.05);
            --accent: #d4908f;
            --accent-light: #3d2828;
            --accent-subtle: rgba(212,144,143,0.07);
            --accent-hover: #e0a5a4;
            --accent-glow: rgba(212,144,143,0.15);
            --accent-deep: #b87070;
            --success: #6db880;
            --success-light: #1e2e22;
            --success-bg: #192119;
            --success-glow: rgba(109,184,128,0.15);
            --warning: #d4b65e;
            --warning-light: #2a2518;
            --error: #d46060;
            --error-light: #2e1a1a;
            --error-bg: #261616;
            --text-primary: #ede5db;
            --text-secondary: #a69b8e;
            --text-tertiary: #6b6358;
            --text-inverse: #1a1714;
            --divider: rgba(255,255,255,0.05);
            --focus-ring: rgba(212,144,143,0.2);
            --overlay: rgba(0,0,0,0.72);
            --glass-border: 1px solid rgba(255,255,255,0.06);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: var(--font-ui);
            background: transparent;
            min-height: 100vh;
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
            transition: background 0.6s ease, color 0.6s ease;
        }

        /* ===== AMBIENT BACKGROUND ===== */
        body::before {
            content: '';
            position: fixed;
            top: -50%; left: -50%;
            width: 200%; height: 200%;
            background:
                radial-gradient(ellipse at 15% 15%, rgba(196,115,110,0.1) 0%, transparent 45%),
                radial-gradient(ellipse at 85% 75%, rgba(196,154,60,0.07) 0%, transparent 45%),
                radial-gradient(ellipse at 45% 55%, rgba(90,158,111,0.05) 0%, transparent 45%),
                radial-gradient(ellipse at 70% 20%, rgba(180,130,200,0.04) 0%, transparent 40%);
            animation: ambientDrift 40s ease-in-out infinite;
            pointer-events: none;
            z-index: 0;
        }

        [data-theme="dark"] body::before {
            background:
                radial-gradient(ellipse at 15% 15%, rgba(196,115,110,0.05) 0%, transparent 45%),
                radial-gradient(ellipse at 85% 75%, rgba(196,154,60,0.03) 0%, transparent 45%),
                radial-gradient(ellipse at 45% 55%, rgba(90,158,111,0.02) 0%, transparent 45%);
        }

        @keyframes ambientDrift {
            0%, 100% { transform: translate(0, 0) rotate(0deg) scale(1); }
            25% { transform: translate(3%, -2%) rotate(1deg) scale(1.02); }
            50% { transform: translate(-2%, 1%) rotate(-0.5deg) scale(0.99); }
            75% { transform: translate(-1%, 3%) rotate(0.5deg) scale(1.01); }
        }

        /* Noise texture overlay */
        body::after {
            content: '';
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
            opacity: 0.025;
            pointer-events: none;
            z-index: 0;
        }

        /* ===== FULLSCREEN BACKGROUND IMAGE ===== */
        .bg-image-layer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background: url('https://c4.wallpaperflare.com/wallpaper/688/794/455/digital-art-pixel-art-pixels-building-pixelated-hd-wallpaper-preview.jpg') no-repeat center center;
            background-size: cover;
            background-attachment: fixed;
            z-index: -2;
        }

        /* Dark overlay on top of the image */
        .bg-image-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background: linear-gradient(
                180deg,
                rgba(44, 36, 25, 0.72) 0%,
                rgba(44, 36, 25, 0.65) 40%,
                rgba(44, 36, 25, 0.78) 100%
            );
            z-index: -1;
            pointer-events: none;
        }

        [data-theme="dark"] .bg-image-overlay {
            background: linear-gradient(
                180deg,
                rgba(10, 8, 5, 0.82) 0%,
                rgba(10, 8, 5, 0.75) 40%,
                rgba(10, 8, 5, 0.88) 100%
            );
        }

        /* Fix for iOS/mobile: background-attachment: fixed breaks on mobile */
        @supports (-webkit-touch-callout: none) {
            .bg-image-layer {
                background-attachment: scroll;
            }
        }

        @media (hover: none) and (pointer: coarse) {
            .bg-image-layer {
                background-attachment: scroll;
            }
        }

        .app-container {
            position: relative;
            z-index: 1;
            max-width: 580px;
            margin: 0 auto;
            padding: 20px 16px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* ===== SVG ICON SYSTEM ===== */
        .icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 20px;
            height: 20px;
            flex-shrink: 0;
        }
        .icon svg {
            width: 100%;
            height: 100%;
            fill: none;
            stroke: currentColor;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        /* ===== HEADER ===== */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
            flex-wrap: wrap;
            gap: 12px;
            animation: headerSlideIn 0.8s cubic-bezier(0.16, 1, 0.3, 1) both;
        }

        @keyframes headerSlideIn {
            from { opacity: 0; transform: translateY(-16px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .app-title {
            font-size: 1.3rem;
            font-weight: 800;
            color: var(--text-primary);
            letter-spacing: -0.04em;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .app-title .title-mark {
            width: 38px;
            height: 38px;
            background: linear-gradient(145deg, var(--accent), var(--accent-deep));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-family: var(--font-jp);
            font-size: 1.05rem;
            font-weight: 900;
            box-shadow: 0 4px 20px var(--accent-glow), inset 0 1px 0 rgba(255,255,255,0.2);
            animation: titleMarkFloat 4s ease-in-out infinite;
            position: relative;
        }

        .app-title .title-mark::after {
            content: '';
            position: absolute;
            inset: -3px;
            border-radius: 14px;
            background: linear-gradient(145deg, var(--accent), var(--accent-deep));
            opacity: 0.25;
            filter: blur(10px);
            z-index: -1;
            animation: titleGlow 4s ease-in-out infinite alternate;
        }

        @keyframes titleMarkFloat {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-3px) rotate(3deg); }
        }

        @keyframes titleGlow {
            0% { opacity: 0.2; filter: blur(10px); }
            100% { opacity: 0.35; filter: blur(14px); }
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .header-user-info {
            display: none;
            align-items: center;
            gap: 6px;
            font-size: 0.82rem;
            color: var(--text-tertiary);
            margin-right: 4px;
        }

        .header-user-name {
            font-weight: 600;
            color: var(--text-secondary);
            max-width: 90px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .header-icon-btn {
            width: 38px;
            height: 38px;
            border: var(--glass-border);
            background: var(--card-bg);
            backdrop-filter: var(--glass-blur);
            -webkit-backdrop-filter: var(--glass-blur);
            border-radius: var(--radius-sm);
            color: var(--text-secondary);
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .header-icon-btn.visible { display: flex; }

        .header-icon-btn::before {
            content: '';
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at center, var(--accent-glow), transparent);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .header-icon-btn:hover {
            color: var(--accent);
            border-color: var(--accent);
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 6px 20px rgba(0,0,0,0.06), 0 0 0 1px var(--accent-glow);
        }
        .header-icon-btn:hover::before { opacity: 1; }
        .header-icon-btn:active { transform: translateY(0) scale(0.92); }

        .sound-btn.muted { opacity: 0.35; }

        .lang-switcher {
            display: flex;
            gap: 2px;
            background: var(--card-bg);
            backdrop-filter: var(--glass-blur);
            -webkit-backdrop-filter: var(--glass-blur);
            padding: 3px;
            border-radius: var(--radius-sm);
            border: var(--glass-border);
        }

        .lang-btn {
            padding: 6px 14px;
            border: none;
            background: transparent;
            font-family: var(--font-ui);
            font-size: 0.8rem;
            font-weight: 700;
            color: var(--text-tertiary);
            cursor: pointer;
            border-radius: 10px;
            transition: var(--transition-fast);
            letter-spacing: 0.05em;
        }

        .lang-btn:hover { color: var(--text-secondary); }
        .lang-btn.active {
            background: var(--accent);
            color: white;
            box-shadow: 0 2px 12px var(--accent-glow);
        }

        /* ===== THEME TOGGLE ===== */
        .theme-toggle {
            width: 38px;
            height: 38px;
            border: var(--glass-border);
            background: var(--card-bg);
            backdrop-filter: var(--glass-blur);
            -webkit-backdrop-filter: var(--glass-blur);
            border-radius: var(--radius-sm);
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition-spring);
        }
        .theme-toggle:hover {
            color: var(--warning);
            border-color: var(--warning);
            transform: translateY(-2px) rotate(20deg);
            box-shadow: 0 6px 20px rgba(196,154,60,0.15);
        }
        .theme-toggle:active { transform: rotate(-10deg) scale(0.88); }
        .theme-toggle .icon-sun,
        [data-theme="dark"] .theme-toggle .icon-moon { display: none; }
        [data-theme="dark"] .theme-toggle .icon-sun { display: flex; }

        /* ===== AUTH SCREEN ===== */
        .auth-screen {
            display: none;
            flex-direction: column;
            align-items: center;
            gap: 24px;
            flex: 1;
            justify-content: center;
        }
        .auth-screen.visible { display: flex; }

        .auth-card {
            background: var(--card-bg);
            backdrop-filter: var(--glass-blur);
            -webkit-backdrop-filter: var(--glass-blur);
            border: var(--glass-border);
            border-radius: var(--radius-xl);
            padding: 48px 38px;
            box-shadow: var(--card-shadow);
            width: 100%;
            max-width: 400px;
            animation: cardRevealBounce 0.7s cubic-bezier(0.175, 0.885, 0.32, 1.1) both;
            position: relative;
            overflow: hidden;
        }

        .auth-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--accent), var(--warning), var(--success), var(--accent));
            background-size: 300% 100%;
            animation: gradientSlide 6s ease infinite;
        }

        @keyframes gradientSlide {
            0%, 100% { background-position: 0% 0%; }
            50% { background-position: 100% 0%; }
        }

        @keyframes cardRevealBounce {
            0% { opacity: 0; transform: translateY(30px) scale(0.95); }
            60% { opacity: 1; transform: translateY(-4px) scale(1.01); }
            100% { opacity: 1; transform: translateY(0) scale(1); }
        }

        .auth-logo { text-align: center; margin-bottom: 32px; }
        .auth-logo-icon {
            width: 68px;
            height: 68px;
            background: linear-gradient(145deg, var(--accent), var(--accent-deep));
            border-radius: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 16px;
            color: white;
            font-family: var(--font-jp);
            font-size: 1.8rem;
            font-weight: 900;
            box-shadow: 0 8px 32px var(--accent-glow), inset 0 2px 0 rgba(255,255,255,0.15);
            animation: logoBreath 5s ease-in-out infinite;
        }

        @keyframes logoBreath {
            0%, 100% { transform: scale(1) rotate(0deg); box-shadow: 0 8px 32px var(--accent-glow); }
            50% { transform: scale(1.06) rotate(1deg); box-shadow: 0 12px 44px var(--accent-glow); }
        }

        .auth-logo-text { font-size: 1.35rem; font-weight: 800; color: var(--text-primary); letter-spacing: -0.03em; }

        .auth-tabs {
            display: flex;
            gap: 2px;
            background: var(--bg-secondary);
            padding: 4px;
            border-radius: var(--radius-sm);
            margin-bottom: 28px;
        }

        .auth-tab {
            flex: 1;
            padding: 12px;
            border: none;
            background: transparent;
            font-family: var(--font-ui);
            font-size: 0.88rem;
            font-weight: 600;
            color: var(--text-tertiary);
            cursor: pointer;
            border-radius: 10px;
            transition: var(--transition);
        }

        .auth-tab.active {
            background: var(--accent);
            color: white;
            box-shadow: 0 3px 14px var(--accent-glow);
        }

        .auth-form { display: flex; flex-direction: column; gap: 18px; }
        .auth-field { display: flex; flex-direction: column; gap: 7px; }
        .auth-field label {
            font-size: 0.78rem;
            font-weight: 700;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }

        .auth-field input {
            padding: 15px 18px;
            border: 1.5px solid var(--divider);
            border-radius: var(--radius-sm);
            font-family: var(--font-ui);
            font-size: 0.95rem;
            font-weight: 500;
            color: var(--text-primary);
            background: var(--bg-primary);
            transition: var(--transition);
            outline: none;
        }
        .auth-field input:focus {
            border-color: var(--accent);
            background: var(--card-bg);
            box-shadow: 0 0 0 4px var(--focus-ring), 0 4px 20px rgba(0,0,0,0.04);
            transform: translateY(-1px);
        }
        .auth-field input.error { border-color: var(--error); box-shadow: 0 0 0 3px rgba(201,80,80,0.15); }

        .auth-error { font-size: 0.82rem; color: var(--error); min-height: 20px; text-align: center; font-weight: 500; }

        .auth-submit-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(145deg, var(--accent), var(--accent-hover));
            border: none;
            border-radius: var(--radius-md);
            font-family: var(--font-ui);
            font-size: 1rem;
            font-weight: 700;
            color: white;
            cursor: pointer;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
            letter-spacing: 0.02em;
            box-shadow: 0 4px 16px var(--accent-glow);
        }
        .auth-submit-btn::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, transparent 30%, rgba(255,255,255,0.18) 50%, transparent 70%);
            transform: translateX(-100%);
            transition: transform 0.6s;
        }
        .auth-submit-btn:hover:not(:disabled)::before { transform: translateX(100%); }
        .auth-submit-btn:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 10px 36px var(--accent-glow);
        }
        .auth-submit-btn:active:not(:disabled) { transform: translateY(0) scale(0.97); }
        .auth-submit-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .auth-submit-btn .spinner {
            display: inline-block;
            width: 16px; height: 16px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
            vertical-align: middle;
            margin-right: 8px;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        /* ===== START SCREEN ===== */
        .start-screen { display: none; flex-direction: column; gap: 20px; }
        .start-screen.visible { display: flex; }

        .lesson-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 12px;
        }

        .lesson-btn {
            background: var(--card-bg);
            backdrop-filter: var(--glass-blur);
            -webkit-backdrop-filter: var(--glass-blur);
            border: var(--glass-border);
            border-radius: var(--radius-md);
            padding: 20px 14px 18px;
            font-family: var(--font-ui);
            font-weight: 700;
            color: var(--text-primary);
            cursor: pointer;
            box-shadow: var(--card-shadow);
            transition: var(--transition);
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            position: relative;
            overflow: hidden;
            animation: lessonBtnAppear 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.1) both;
        }

        .lesson-btn::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--accent), transparent);
            opacity: 0;
            transition: opacity 0.4s;
        }

        .lesson-btn:hover {
            transform: translateY(-6px) scale(1.02);
            border-color: var(--accent);
            box-shadow: var(--card-shadow-hover), 0 0 0 1px var(--accent-glow);
        }
        .lesson-btn:hover::before { opacity: 1; }
        .lesson-btn:active { transform: translateY(-2px) scale(0.97); transition: var(--transition-fast); }

        @keyframes lessonBtnAppear {
            0% { opacity: 0; transform: translateY(24px) scale(0.92); }
            60% { transform: translateY(-2px) scale(1.01); }
            100% { opacity: 1; transform: translateY(0) scale(1); }
        }

        /* Stagger animation for lesson buttons */
        .lesson-btn:nth-child(1) { animation-delay: 0.03s; }
        .lesson-btn:nth-child(2) { animation-delay: 0.07s; }
        .lesson-btn:nth-child(3) { animation-delay: 0.11s; }
        .lesson-btn:nth-child(4) { animation-delay: 0.15s; }
        .lesson-btn:nth-child(5) { animation-delay: 0.19s; }
        .lesson-btn:nth-child(6) { animation-delay: 0.23s; }
        .lesson-btn:nth-child(7) { animation-delay: 0.27s; }
        .lesson-btn:nth-child(8) { animation-delay: 0.31s; }
        .lesson-btn:nth-child(9) { animation-delay: 0.35s; }
        .lesson-btn:nth-child(10) { animation-delay: 0.39s; }

        .lesson-btn.all-lessons {
            background: linear-gradient(145deg, var(--accent-subtle), rgba(196,115,110,0.03));
            border-color: var(--accent-light);
            grid-column: 1 / -1;
            flex-direction: row;
            justify-content: center;
            gap: 10px;
        }
        .lesson-btn.all-lessons:hover {
            background: linear-gradient(145deg, rgba(196,115,110,0.14), rgba(196,115,110,0.06));
        }

        .lesson-btn-name { font-size: 0.95rem; letter-spacing: -0.01em; }

        .lesson-progress-wrap { width: 100%; display: flex; flex-direction: column; gap: 5px; }

        .lesson-progress-track {
            width: 100%; height: 6px;
            background: var(--bg-secondary);
            border-radius: 3px;
            overflow: hidden;
            position: relative;
        }

        .lesson-progress-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 1s cubic-bezier(0.4, 0, 0.2, 1);
            min-width: 0;
            position: relative;
        }

        .lesson-progress-fill.low { background: linear-gradient(90deg, var(--accent), #d4908f); }
        .lesson-progress-fill.mid { background: linear-gradient(90deg, var(--warning), #d4c060); }
        .lesson-progress-fill.high { background: linear-gradient(90deg, var(--success), #7bc48d); }

        .lesson-progress-fill::after {
            content: '';
            position: absolute;
            right: 0; top: 0;
            width: 20px; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.5));
            border-radius: 3px;
        }

        .lesson-progress-text { font-size: 0.7rem; font-weight: 600; color: var(--text-tertiary); }

        .section-title {
            font-size: 1.2rem;
            font-weight: 800;
            margin-bottom: 6px;
            color: var(--text-secondary);
            text-align: center;
            letter-spacing: -0.02em;
            animation: fadeInUp 0.5s cubic-bezier(0.16, 1, 0.3, 1) both;
        }

        /* ===== QUIZ PROGRESS BAR ===== */
        .quiz-progress-bar-wrap {
            width: 100%; height: 6px;
            background: var(--bg-tertiary);
            border-radius: 3px;
            margin-bottom: 24px;
            overflow: hidden;
            position: relative;
        }

        .quiz-progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), #d48f5e, var(--success));
            border-radius: 3px;
            transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            box-shadow: 0 0 16px var(--accent-glow);
        }

        .quiz-progress-bar-fill::after {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            animation: shimmer 2.5s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(200%); }
        }

        /* ===== SCORE DISPLAY ===== */
        .score-display {
            display: flex;
            justify-content: center;
            gap: 48px;
            margin-bottom: 28px;
            animation: fadeInUp 0.5s cubic-bezier(0.16, 1, 0.3, 1) 0.1s both;
        }
        .score-item { text-align: center; }
        .score-label {
            font-size: 0.7rem;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.12em;
            font-weight: 700;
            margin-bottom: 6px;
        }
        .score-value {
            font-size: 1.6rem;
            font-weight: 800;
            color: var(--text-primary);
            letter-spacing: -0.04em;
            transition: var(--transition-spring);
        }
        .score-value.bump {
            animation: scoreBump 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes scoreBump {
            0% { transform: scale(1); }
            40% { transform: scale(1.25); color: var(--success); }
            100% { transform: scale(1); }
        }

        /* ===== QUESTION CARD ===== */
        .question-card {
            background: var(--card-bg);
            backdrop-filter: var(--glass-blur);
            -webkit-backdrop-filter: var(--glass-blur);
            border: var(--glass-border);
            border-radius: var(--radius-xl);
            padding: 52px 32px;
            box-shadow: var(--card-shadow);
            margin-bottom: 20px;
            text-align: center;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .question-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--accent), var(--warning), var(--success), var(--accent));
            background-size: 300% 100%;
            animation: gradientSlide 6s ease infinite;
        }

        /* Decorative Japanese enso circle */
        .question-card::after {
            content: '';
            position: absolute;
            top: 50%; left: 50%;
            width: 180px; height: 180px;
            border: 2.5px solid var(--divider);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            opacity: 0.25;
            pointer-events: none;
            animation: ensoSpin 30s linear infinite;
        }

        @keyframes ensoSpin {
            from { transform: translate(-50%, -50%) rotate(0deg); }
            to { transform: translate(-50%, -50%) rotate(360deg); }
        }

        .question-number {
            font-size: 0.72rem;
            color: var(--accent);
            margin-bottom: 18px;
            font-weight: 700;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            position: relative;
            z-index: 1;
        }

        .japanese-word {
            font-family: var(--font-jp);
            font-size: 3.2rem;
            font-weight: 700;
            color: var(--text-primary);
            line-height: 1.4;
            margin-bottom: 8px;
            position: relative;
            z-index: 1;
            animation: wordReveal 0.6s cubic-bezier(0.16, 1, 0.3, 1) both;
        }

        @keyframes wordReveal {
            0% { opacity: 0; transform: scale(0.85) translateY(8px); filter: blur(4px); }
            100% { opacity: 1; transform: scale(1) translateY(0); filter: blur(0); }
        }

        ruby { ruby-align: center; }
        ruby rt {
            font-size: 0.38em;
            color: var(--text-tertiary);
            font-weight: 400;
            user-select: none;
        }

        /* ===== ANSWER OPTIONS ===== */
        .options-container { display: grid; gap: 10px; margin-bottom: 24px; }
        .options-container.locked { pointer-events: none; }

        .option-btn {
            background: var(--card-bg);
            backdrop-filter: var(--glass-blur);
            -webkit-backdrop-filter: var(--glass-blur);
            border: 1.5px solid var(--card-border);
            border-radius: var(--radius-md);
            padding: 20px 24px;
            font-family: var(--font-ui);
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            cursor: pointer;
            transition: var(--transition);
            text-align: left;
            position: relative;
            overflow: hidden;
        }

        .option-btn::before {
            content: '';
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at var(--mouse-x, 50%) var(--mouse-y, 50%), var(--card-glow), transparent 60%);
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .option-btn::after {
            content: '';
            position: absolute;
            top: 0; left: 0;
            width: 3px; height: 100%;
            background: var(--accent);
            opacity: 0;
            transition: opacity 0.3s, transform 0.3s;
            transform: scaleY(0);
            border-radius: 0 2px 2px 0;
        }

        .option-btn:hover:not(:disabled) {
            border-color: var(--accent);
            transform: translateY(-3px) translateX(2px);
            box-shadow: var(--card-shadow-hover);
        }
        .option-btn:hover:not(:disabled)::before { opacity: 1; }
        .option-btn:hover:not(:disabled)::after { opacity: 1; transform: scaleY(1); }
        .option-btn:active:not(:disabled) { transform: translateY(0) scale(0.97); transition: var(--transition-fast); }
        .option-btn:disabled { cursor: default; }

        .option-btn.correct {
            background: var(--success-bg);
            border-color: var(--success);
            color: var(--success);
            animation: correctPop 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 0 24px var(--success-glow), 0 4px 16px rgba(90,158,111,0.12);
        }
        .option-btn.correct::after { opacity: 1; transform: scaleY(1); background: var(--success); }
        
        .option-btn.incorrect {
            background: var(--error-bg);
            border-color: var(--error);
            color: var(--error);
            animation: shake 0.6s cubic-bezier(0.36, 0.07, 0.19, 0.97);
            box-shadow: 0 0 24px rgba(201,80,80,0.15);
        }
        .option-btn.incorrect::after { opacity: 1; transform: scaleY(1); background: var(--error); }

        @keyframes correctPop {
            0% { transform: scale(1); }
            30% { transform: scale(1.04) translateY(-2px); }
            60% { transform: scale(0.98); }
            100% { transform: scale(1); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10% { transform: translateX(-8px) rotate(-1.5deg); }
            20% { transform: translateX(7px) rotate(1.5deg); }
            30% { transform: translateX(-6px) rotate(-1deg); }
            40% { transform: translateX(5px) rotate(1deg); }
            50% { transform: translateX(-3px); }
            60% { transform: translateX(2px); }
        }

        /* ===== MODAL ===== */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: var(--overlay);
            backdrop-filter: blur(16px) saturate(1.3);
            -webkit-backdrop-filter: blur(16px) saturate(1.3);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
            padding: 16px;
        }
        .modal-overlay.visible { opacity: 1; visibility: visible; }

        .modal-content {
            background: var(--card-bg);
            backdrop-filter: var(--glass-blur);
            -webkit-backdrop-filter: var(--glass-blur);
            border: var(--glass-border);
            border-radius: var(--radius-xl);
            padding: 40px;
            max-width: 480px;
            width: 100%;
            max-height: 85vh;
            overflow-y: auto;
            transform: translateY(30px) scale(0.92);
            transition: all 0.45s cubic-bezier(0.175, 0.885, 0.32, 1.1);
            box-shadow: 0 28px 90px rgba(0,0,0,0.28);
        }
        .modal-overlay.visible .modal-content { transform: translateY(0) scale(1); }

        /* Scrollbar */
        .modal-content::-webkit-scrollbar { width: 5px; }
        .modal-content::-webkit-scrollbar-track { background: transparent; }
        .modal-content::-webkit-scrollbar-thumb { background: var(--text-tertiary); border-radius: 3px; }

        .result-header { text-align: center; margin-bottom: 26px; }

        .result-icon {
            width: 68px; height: 68px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 16px;
            position: relative;
        }
        .result-icon.correct {
            background: var(--success-light);
            color: var(--success);
            box-shadow: 0 0 36px var(--success-glow);
            animation: iconPopIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .result-icon.correct::after {
            content: '';
            position: absolute;
            inset: -6px;
            border: 2px solid var(--success);
            border-radius: 50%;
            opacity: 0;
            animation: iconRing 0.8s 0.2s ease-out forwards;
        }
        .result-icon.incorrect {
            background: var(--error-light);
            color: var(--error);
            box-shadow: 0 0 36px rgba(201,80,80,0.15);
            animation: iconPopIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .result-icon.incorrect::after {
            content: '';
            position: absolute;
            inset: -6px;
            border: 2px solid var(--error);
            border-radius: 50%;
            opacity: 0;
            animation: iconRing 0.8s 0.2s ease-out forwards;
        }

        @keyframes iconPopIn {
            0% { transform: scale(0) rotate(-30deg); }
            50% { transform: scale(1.2) rotate(8deg); }
            75% { transform: scale(0.95) rotate(-3deg); }
            100% { transform: scale(1) rotate(0deg); }
        }
        
        @keyframes iconRing {
            0% { transform: scale(0.8); opacity: 0.6; }
            100% { transform: scale(1.3); opacity: 0; }
        }

        .result-icon .icon { width: 30px; height: 30px; }

        .result-title { font-size: 1.5rem; font-weight: 800; margin-bottom: 6px; letter-spacing: -0.03em; }
        .result-title.correct { color: var(--success); }
        .result-title.incorrect { color: var(--error); }

        .correct-answer-text { font-size: 1.05rem; color: var(--text-secondary); font-weight: 500; }
        .correct-answer-text strong { color: var(--text-primary); font-family: var(--font-jp); }

        .example-section {
            background: var(--card-bg-elevated);
            border: 1px solid var(--divider);
            border-radius: var(--radius-md);
            padding: 20px;
            margin-bottom: 14px;
            transition: var(--transition);
        }
        .example-section:hover { border-color: var(--card-border); transform: translateX(2px); }

        .example-label {
            font-size: 0.68rem;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            font-weight: 700;
            margin-bottom: 12px;
        }
        .example-jp {
            font-family: var(--font-jp);
            font-size: 1.15rem;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 6px;
            line-height: 1.7;
        }
        .example-translation {
            font-style: italic;
            color: var(--text-secondary);
            font-size: 0.92rem;
            font-weight: 400;
        }

        .grammar-section {
            background: var(--warning-light);
            border-left: 4px solid var(--warning);
            border-radius: 0 var(--radius-md) var(--radius-md) 0;
            padding: 20px 22px;
            margin-bottom: 24px;
            position: relative;
            overflow: hidden;
        }
        .grammar-section::after {
            content: 'æ–‡';
            position: absolute;
            right: 14px; top: 8px;
            font-family: var(--font-jp);
            font-size: 4rem;
            font-weight: 900;
            opacity: 0.04;
            color: var(--warning);
            line-height: 1;
        }
        .grammar-label {
            display: flex; align-items: center; gap: 8px;
            font-size: 0.72rem; font-weight: 700; color: var(--warning);
            text-transform: uppercase; letter-spacing: 0.08em; margin-bottom: 10px;
        }
        .grammar-label .icon { width: 16px; height: 16px; }
        .grammar-label .icon svg { stroke: var(--warning); }
        .grammar-text { font-size: 0.9rem; color: var(--text-primary); line-height: 1.6; white-space: pre-line; }

        .next-btn {
            width: 100%;
            padding: 18px 24px;
            background: linear-gradient(145deg, var(--accent), var(--accent-hover));
            border: none;
            border-radius: var(--radius-md);
            font-family: var(--font-ui);
            font-size: 1.05rem;
            font-weight: 700;
            color: white;
            cursor: pointer;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
            letter-spacing: 0.02em;
            box-shadow: 0 4px 16px var(--accent-glow);
        }
        .next-btn::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, transparent 30%, rgba(255,255,255,0.14) 50%, transparent 70%);
            transform: translateX(-100%);
            transition: transform 0.6s;
        }
        .next-btn:hover:not(:disabled)::before { transform: translateX(100%); }
        .next-btn:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 10px 36px var(--accent-glow);
        }
        .next-btn:active:not(:disabled) { transform: translateY(0) scale(0.97); }
        .next-btn:disabled { background: var(--text-tertiary); cursor: not-allowed; box-shadow: none; }
        .next-btn.counting { background: var(--text-tertiary); box-shadow: none; }
        .next-btn .timer-bar {
            position: absolute;
            bottom: 0; left: 0;
            height: 4px;
            background: rgba(255,255,255,0.55);
            transition: width 1s linear;
            border-radius: 0 2px 2px 0;
        }

        /* ===== RESULTS ===== */
        .results-screen { display: none; }
        .results-screen.visible { display: block; }

        .results-card {
            background: var(--card-bg);
            backdrop-filter: var(--glass-blur);
            -webkit-backdrop-filter: var(--glass-blur);
            border: var(--glass-border);
            border-radius: var(--radius-xl);
            padding: 48px 38px;
            box-shadow: var(--card-shadow);
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .results-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--success), var(--warning), var(--accent));
            background-size: 200% 100%;
            animation: gradientSlide 4s ease infinite;
        }

        .final-score {
            font-size: 4.5rem;
            font-weight: 800;
            background: linear-gradient(145deg, var(--accent), #e89090, var(--accent-deep));
            background-size: 200% 200%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 4px;
            letter-spacing: -0.04em;
            line-height: 1.1;
            animation: scoreCountUp 0.9s cubic-bezier(0.175, 0.885, 0.32, 1.1) both, scoreGradient 4s ease infinite;
        }
        
        @keyframes scoreGradient {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        @keyframes scoreCountUp {
            0% { opacity: 0; transform: scale(0.4) translateY(24px); filter: blur(4px); }
            60% { transform: scale(1.08) translateY(-4px); }
            100% { opacity: 1; transform: scale(1) translateY(0); filter: blur(0); }
        }

        .final-score-label { color: var(--text-tertiary); margin-bottom: 28px; font-size: 0.9rem; font-weight: 500; }

        .mistakes-container { text-align: left; margin-top: 28px; padding-top: 24px; border-top: 1px solid var(--divider); }
        .mistakes-title {
            font-size: 0.92rem; font-weight: 700; color: var(--error); margin-bottom: 16px;
            display: flex; align-items: center; gap: 8px;
        }
        .mistakes-title .icon { width: 18px; height: 18px; }
        .mistakes-title .icon svg { stroke: var(--error); }
        .mistakes-list { max-height: 300px; overflow-y: auto; padding-right: 6px; }
        .mistakes-list::-webkit-scrollbar { width: 4px; }
        .mistakes-list::-webkit-scrollbar-track { background: transparent; }
        .mistakes-list::-webkit-scrollbar-thumb { background: var(--text-tertiary); border-radius: 2px; }

        .mistake-item {
            background: var(--error-bg);
            border: 1px solid var(--error-light);
            border-radius: var(--radius-sm);
            padding: 16px 18px;
            margin-bottom: 10px;
            animation: fadeInUp 0.4s ease-out both;
            border-left: 3px solid var(--error);
            transition: var(--transition);
        }
        .mistake-item:hover { transform: translateX(4px); }
        .mistake-item:nth-child(1) { animation-delay: 0.05s; }
        .mistake-item:nth-child(2) { animation-delay: 0.1s; }
        .mistake-item:nth-child(3) { animation-delay: 0.15s; }
        .mistake-item:nth-child(4) { animation-delay: 0.2s; }
        .mistake-item:nth-child(5) { animation-delay: 0.25s; }

        .mistake-word { font-family: var(--font-jp); font-size: 1.2rem; font-weight: 500; margin-bottom: 3px; }
        .mistake-answer { font-size: 0.88rem; color: var(--text-secondary); font-weight: 500; }

        .restart-btn {
            margin-top: 24px;
            width: 100%;
            padding: 18px 24px;
            background: linear-gradient(145deg, var(--success), #4a8e5f);
            border: none;
            border-radius: var(--radius-md);
            font-family: var(--font-ui);
            font-size: 1.05rem;
            font-weight: 700;
            color: white;
            cursor: pointer;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 16px var(--success-glow);
        }
        .restart-btn::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, transparent 30%, rgba(255,255,255,0.14) 50%, transparent 70%);
            transform: translateX(-100%);
            transition: transform 0.6s;
        }
        .restart-btn:hover::before { transform: translateX(100%); }
        .restart-btn:hover { transform: translateY(-3px); box-shadow: 0 10px 36px var(--success-glow); }
        .restart-btn:active { transform: translateY(0) scale(0.97); }

        /* ===== LEADERBOARD ===== */
        .leaderboard-screen { display: none; flex-direction: column; gap: 14px; }
        .leaderboard-screen.visible { display: flex; }

        .leaderboard-card {
            background: var(--card-bg);
            backdrop-filter: var(--glass-blur);
            -webkit-backdrop-filter: var(--glass-blur);
            border: var(--glass-border);
            border-radius: var(--radius-xl);
            padding: 32px;
            box-shadow: var(--card-shadow);
            animation: cardRevealBounce 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.1) both;
        }
        .leaderboard-title {
            font-size: 1.25rem; font-weight: 800; text-align: center; margin-bottom: 24px;
            display: flex; align-items: center; justify-content: center; gap: 10px; letter-spacing: -0.02em;
        }
        .leaderboard-title .icon { width: 24px; height: 24px; color: var(--warning); }
        .leaderboard-title .icon svg { stroke: var(--warning); }
        .leaderboard-list { display: flex; flex-direction: column; gap: 8px; }

        .leaderboard-row {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 14px 16px;
            background: var(--card-bg-elevated);
            border: 1px solid var(--divider);
            border-radius: var(--radius-sm);
            transition: var(--transition);
            animation: fadeInUp 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.1) both;
        }
        .leaderboard-row:nth-child(1) { animation-delay: 0.05s; }
        .leaderboard-row:nth-child(2) { animation-delay: 0.1s; }
        .leaderboard-row:nth-child(3) { animation-delay: 0.15s; }
        .leaderboard-row:nth-child(4) { animation-delay: 0.2s; }
        .leaderboard-row:nth-child(5) { animation-delay: 0.25s; }

        .leaderboard-row:hover { transform: translateX(6px); border-color: var(--card-border); }
        .leaderboard-row.current-user {
            background: var(--accent-subtle);
            border-color: var(--accent-light);
            box-shadow: 0 0 0 1px var(--accent-glow);
        }
        .leaderboard-rank {
            font-size: 1.05rem; font-weight: 800; min-width: 34px; text-align: center;
            color: var(--text-secondary); letter-spacing: -0.02em;
        }
        .leaderboard-rank.gold { color: #c9a84c; text-shadow: 0 0 16px rgba(201,168,76,0.35); }
        .leaderboard-rank.silver { color: #8f9aa3; }
        .leaderboard-rank.bronze { color: #b87333; }

        .leaderboard-info { flex: 1; min-width: 0; }
        .leaderboard-name {
            font-weight: 700; font-size: 0.92rem; color: var(--text-primary);
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }

        .leaderboard-stats { display: flex; align-items: center; gap: 8px; margin-top: 5px; }
        .leaderboard-bar-track { flex: 1; height: 6px; background: var(--bg-secondary); border-radius: 3px; overflow: hidden; }
        .leaderboard-bar-fill { height: 100%; border-radius: 3px; transition: width 1s ease; }
        .leaderboard-percent { font-size: 0.78rem; font-weight: 700; color: var(--text-tertiary); min-width: 40px; text-align: right; }

        .leaderboard-empty { text-align: center; color: var(--text-tertiary); padding: 28px; font-size: 0.9rem; font-weight: 500; }

        .quiz-back-btn,
        .leaderboard-back-btn,
        .dictionary-back-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(145deg, var(--success), #4a8e5f);
            border: none;
            border-radius: var(--radius-md);
            font-family: var(--font-ui);
            font-size: 1rem;
            font-weight: 700;
            color: white;
            cursor: pointer;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 16px var(--success-glow);
        }
        .quiz-back-btn::before,
        .leaderboard-back-btn::before,
        .dictionary-back-btn::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, transparent 30%, rgba(255,255,255,0.14) 50%, transparent 70%);
            transform: translateX(-100%);
            transition: transform 0.6s;
        }
        .quiz-back-btn:hover::before,
        .leaderboard-back-btn:hover::before,
        .dictionary-back-btn:hover::before { transform: translateX(100%); }
        .quiz-back-btn:hover,
        .leaderboard-back-btn:hover,
        .dictionary-back-btn:hover { transform: translateY(-3px); box-shadow: 0 10px 36px var(--success-glow); }
        .quiz-back-btn:active,
        .leaderboard-back-btn:active,
        .dictionary-back-btn:active { transform: translateY(0) scale(0.97); }
        .quiz-back-btn { margin-top: 16px; }

        /* ===== QUIZ CONTAINER ===== */
        .quiz-container { display: none; }
        .quiz-container.visible { display: block; }

        /* ===== SAKURA PETALS ===== */
        .sakura-container {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none;
            z-index: 0;
            overflow: hidden;
        }

        .sakura-petal {
            position: absolute;
            top: -30px;
            display: block;
            font-size: 14px;
            line-height: 1;
            opacity: 0.3;
            animation: sakuraFall linear infinite, sakuraSway ease-in-out infinite;
            filter: drop-shadow(0 1px 2px rgba(196,115,110,0.15));
            user-select: none;
        }

        [data-theme="dark"] .sakura-petal { opacity: 0.12; }

        @keyframes sakuraFall {
            0% { top: -30px; }
            100% { top: 105vh; }
        }

        @keyframes sakuraSway {
            0%, 100% { transform: translateX(0) rotate(0deg) scale(1); }
            20% { transform: translateX(25px) rotate(45deg) scale(1.1); }
            40% { transform: translateX(-15px) rotate(110deg) scale(0.9); }
            60% { transform: translateX(20px) rotate(180deg) scale(1.05); }
            80% { transform: translateX(-10px) rotate(250deg) scale(0.95); }
        }

        .sakura-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 50;
            width: 46px;
            height: 46px;
            border: var(--glass-border);
            background: var(--card-bg);
            backdrop-filter: var(--glass-blur);
            -webkit-backdrop-filter: var(--glass-blur);
            border-radius: 50%;
            color: var(--accent);
            cursor: pointer;
            box-shadow: var(--card-shadow);
            transition: var(--transition-spring);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
        }
        .sakura-emoji {
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition-spring);
        }
        .sakura-toggle:hover {
            transform: scale(1.18) rotate(15deg);
            border-color: var(--accent);
            box-shadow: 0 8px 32px var(--accent-glow);
        }
        .sakura-toggle:hover .sakura-emoji { transform: scale(1.15); }
        .sakura-toggle:active { transform: scale(0.9) rotate(-5deg); }
        .sakura-toggle.off { opacity: 0.3; }
        .sakura-toggle.off .sakura-emoji { filter: grayscale(1); }

        /* ===== DICTIONARY SCREEN ===== */
        .dictionary-screen { display: none; flex-direction: column; gap: 14px; }
        .dictionary-screen.visible { display: flex; }

        .dictionary-card {
            background: var(--card-bg);
            backdrop-filter: var(--glass-blur);
            -webkit-backdrop-filter: var(--glass-blur);
            border: var(--glass-border);
            border-radius: var(--radius-xl);
            padding: 32px;
            box-shadow: var(--card-shadow);
            animation: cardRevealBounce 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.1) both;
        }

        .dictionary-title {
            font-size: 1.25rem;
            font-weight: 800;
            text-align: center;
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            letter-spacing: -0.02em;
        }
        .dictionary-title .icon { width: 24px; height: 24px; color: var(--accent); }
        .dictionary-title .icon svg { stroke: var(--accent); }

        .dict-breadcrumb {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.82rem;
            color: var(--text-tertiary);
            margin-bottom: 18px;
            flex-wrap: wrap;
            font-weight: 500;
        }
        .dict-breadcrumb-link {
            color: var(--accent);
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition-fast);
        }
        .dict-breadcrumb-link:hover { opacity: 0.7; text-decoration: underline; }
        .dict-breadcrumb-sep { color: var(--text-tertiary); opacity: 0.5; }
        .dict-breadcrumb-current { color: var(--text-primary); font-weight: 700; }

        .dict-lesson-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 12px;
        }

        .dict-lesson-btn {
            background: var(--card-bg-elevated);
            border: 1.5px solid var(--divider);
            border-radius: var(--radius-md);
            padding: 20px 14px;
            font-family: var(--font-ui);
            font-weight: 700;
            font-size: 0.95rem;
            color: var(--text-primary);
            cursor: pointer;
            transition: var(--transition);
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            position: relative;
            overflow: hidden;
            animation: lessonBtnAppear 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.1) both;
        }
        .dict-lesson-btn:nth-child(1) { animation-delay: 0.03s; }
        .dict-lesson-btn:nth-child(2) { animation-delay: 0.07s; }
        .dict-lesson-btn:nth-child(3) { animation-delay: 0.11s; }
        .dict-lesson-btn:nth-child(4) { animation-delay: 0.15s; }
        .dict-lesson-btn:nth-child(5) { animation-delay: 0.19s; }
        .dict-lesson-btn:nth-child(6) { animation-delay: 0.23s; }

        .dict-lesson-btn:hover {
            border-color: var(--accent);
            transform: translateY(-6px) scale(1.02);
            box-shadow: var(--card-shadow-hover);
        }
        .dict-lesson-btn:active { transform: translateY(-2px) scale(0.97); }

        .dict-lesson-count { font-size: 0.73rem; font-weight: 600; color: var(--text-tertiary); }

        .dict-lesson-icon {
            width: 38px;
            height: 38px;
            background: var(--accent-subtle);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--accent);
            margin-bottom: 2px;
            transition: var(--transition-spring);
        }
        .dict-lesson-btn:hover .dict-lesson-icon {
            background: var(--accent);
            color: white;
            transform: scale(1.15) rotate(5deg);
        }
        .dict-lesson-icon .icon { width: 18px; height: 18px; }
        .dict-lesson-icon .icon svg { stroke: currentColor; }

        .dict-words-list { display: flex; flex-direction: column; gap: 8px; }

        .dict-word-card {
            background: var(--card-bg-elevated);
            border: 1.5px solid var(--divider);
            border-radius: var(--radius-sm);
            padding: 16px 20px;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 3px solid transparent;
        }
        .dict-word-card:hover {
            border-color: var(--accent);
            border-left-color: var(--accent);
            transform: translateX(8px);
            box-shadow: var(--card-shadow);
            background: var(--card-bg);
        }

        .dict-word-jp { font-family: var(--font-jp); font-size: 1.25rem; font-weight: 500; color: var(--text-primary); line-height: 1.5; }
        .dict-word-trans { font-size: 0.85rem; color: var(--text-secondary); font-weight: 600; margin-top: 2px; }
        .dict-word-arrow { color: var(--text-tertiary); margin-left: 12px; flex-shrink: 0; transition: var(--transition); }
        .dict-word-card:hover .dict-word-arrow { color: var(--accent); transform: translateX(4px); }
        .dict-word-arrow .icon { width: 16px; height: 16px; }

        .dict-detail-header {
            text-align: center;
            padding: 28px 0 28px;
            border-bottom: 1px solid var(--divider);
            margin-bottom: 24px;
            position: relative;
        }

        .dict-detail-header::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 50%;
            transform: translateX(-50%);
            width: 48px; height: 3px;
            background: linear-gradient(90deg, var(--accent), var(--accent-deep));
            border-radius: 2px;
        }

        .dict-detail-jp {
            font-family: var(--font-jp);
            font-size: 2.8rem;
            font-weight: 700;
            color: var(--text-primary);
            line-height: 1.4;
            margin-bottom: 8px;
            animation: wordReveal 0.5s cubic-bezier(0.16, 1, 0.3, 1) both;
        }
        .dict-detail-trans { font-size: 1.1rem; color: var(--text-secondary); font-weight: 600; }

        .dict-examples-label {
            font-size: 0.68rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-tertiary);
            margin-bottom: 14px;
            font-weight: 700;
        }

        .dict-example-item {
            background: var(--card-bg-elevated);
            border: 1px solid var(--divider);
            border-radius: var(--radius-sm);
            padding: 16px 18px;
            margin-bottom: 10px;
            transition: var(--transition);
            border-left: 3px solid transparent;
        }
        .dict-example-item:hover {
            border-left-color: var(--accent);
            transform: translateX(6px);
        }

        .dict-example-jp { font-family: var(--font-jp); font-size: 1.05rem; font-weight: 500; color: var(--text-primary); line-height: 1.7; margin-bottom: 4px; }
        .dict-example-trans { font-size: 0.85rem; color: var(--text-secondary); font-style: italic; line-height: 1.4; }

        .dict-grammar-note {
            background: var(--warning-light);
            border-left: 4px solid var(--warning);
            border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
            padding: 16px 18px;
            margin-top: 18px;
        }

        .dict-grammar-label {
            font-size: 0.68rem; font-weight: 700; color: var(--warning); text-transform: uppercase;
            letter-spacing: 0.08em; margin-bottom: 10px; display: flex; align-items: center; gap: 6px;
        }
        .dict-grammar-label .icon { width: 14px; height: 14px; }
        .dict-grammar-label .icon svg { stroke: var(--warning); }
        .dict-grammar-text { font-size: 0.88rem; color: var(--text-primary); line-height: 1.55; white-space: pre-line; }

        /* ===== CONFETTI BURST ===== */
        .confetti-container {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none;
            z-index: 999;
            overflow: hidden;
        }
        .confetti-particle {
            position: absolute;
            width: 8px; height: 8px;
            border-radius: 2px;
            animation: confettiFall 1.2s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
            opacity: 0.9;
        }
        @keyframes confettiFall {
            0% { transform: translate(0, 0) rotate(0deg) scale(1); opacity: 0.9; }
            100% { transform: translate(var(--tx), var(--ty)) rotate(var(--tr)) scale(0); opacity: 0; }
        }

        /* ===== ANIMATIONS ===== */
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(18px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes cardReveal {
            from { opacity: 0; transform: translateY(24px) scale(0.97); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        .question-card { animation: cardRevealBounce 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.1) both; }
        .start-screen { animation: fadeInUp 0.5s cubic-bezier(0.16, 1, 0.3, 1) both; }
        .results-card { animation: cardRevealBounce 0.7s cubic-bezier(0.175, 0.885, 0.32, 1.1) both; }

        .option-btn { animation: optionSlideIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.1); animation-fill-mode: both; }
        @keyframes optionSlideIn {
            0% { opacity: 0; transform: translateX(-16px) translateY(8px); }
            100% { opacity: 1; transform: translateX(0) translateY(0); }
        }
        .option-btn:nth-child(1) { animation-delay: 0.06s; }
        .option-btn:nth-child(2) { animation-delay: 0.12s; }
        .option-btn:nth-child(3) { animation-delay: 0.18s; }
        .option-btn:nth-child(4) { animation-delay: 0.24s; }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 480px) {
            .app-container { padding: 14px 12px; }
            .header { flex-direction: column; gap: 10px; text-align: center; }
            .header-right { justify-content: center; flex-wrap: wrap; }
            .app-title { font-size: 1.15rem; }
            .japanese-word { font-size: 2.5rem; }
            .question-card { padding: 40px 22px; }
            .option-btn { padding: 17px 20px; font-size: 0.95rem; }
            .modal-content { padding: 28px; }
            .result-title { font-size: 1.3rem; }
            .example-jp { font-size: 1.05rem; }
            .lesson-grid { grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); }
            .auth-card { padding: 32px 22px; }
            .dictionary-card, .leaderboard-card { padding: 22px 16px; }
            .dict-detail-jp { font-size: 2.2rem; }
            .dict-lesson-grid { grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); }
            .sakura-toggle { bottom: 14px; right: 14px; width: 42px; height: 42px; }
            .final-score { font-size: 3.5rem; }
        }

        /* ===== SELECTION STYLING ===== */
        ::selection {
            background: var(--accent-light);
            color: var(--text-primary);
        }

        /* ===== SMOOTH SCROLLBAR ===== */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--text-tertiary); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-secondary); }
    </style>
</head>
<body>
<!-- Fullscreen background image layer -->
<div class="bg-image-layer" aria-hidden="true"></div>
<div class="bg-image-overlay" aria-hidden="true"></div>

    <!-- Sakura petals background -->
    <div class="sakura-container" id="sakura-container"></div>
    <button class="sakura-toggle" id="sakura-toggle" title="Toggle petals">
        <span class="sakura-emoji">ðŸŒ¸</span>
    </button>

    <div class="app-container">
        <header class="header">
            <div class="app-title" id="app-title">
                <span class="title-mark">æ—¥</span>
                Minna no Nihongo
            </div>
            <div class="header-right">
                <div class="header-user-info" id="header-user-info">
                    <span class="header-user-name" id="header-user-name"></span>
                </div>
                <button class="header-icon-btn sound-btn" id="sound-toggle-btn" title="Sound">
                    <span class="icon"><svg viewBox="0 0 24 24"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/></svg></span>
                </button>
                <button class="header-icon-btn" id="leaderboard-btn" title="Leaderboard">
                    <span class="icon"><svg viewBox="0 0 24 24"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5C7 4 7 7 7 7"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5C17 4 17 7 17 7"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></svg></span>
                </button>
                <button class="header-icon-btn" id="dictionary-btn" title="Dictionary">
                    <span class="icon"><svg viewBox="0 0 24 24"><path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20"/><path d="M8 7h6"/><path d="M8 11h4"/></svg></span>
                </button>
                <button class="theme-toggle" id="theme-toggle-btn" title="Theme">
                    <span class="icon icon-moon"><svg viewBox="0 0 24 24"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg></span>
                    <span class="icon icon-sun"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></span>
                </button>
                <div class="lang-switcher">
                    <button class="lang-btn active" data-lang="ru">RU</button>
                    <button class="lang-btn" data-lang="uz">UZ</button>
                </div>
                <button class="header-icon-btn" id="logout-btn" title="Logout">
                    <span class="icon"><svg viewBox="0 0 24 24"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg></span>
                </button>
            </div>
        </header>

        <!-- Auth Screen -->
        <div id="auth-screen" class="auth-screen">
            <div class="auth-card">
                <div class="auth-logo">
                    <div class="auth-logo-icon">æ—¥</div>
                    <div class="auth-logo-text">Minna no Nihongo</div>
                </div>
                <div class="auth-tabs">
                    <button class="auth-tab active" id="tab-login" data-tab="login">Ð’Ð¾Ð¹Ñ‚Ð¸</button>
                    <button class="auth-tab" id="tab-register" data-tab="register">Ð ÐµÐ³Ð¸ÑÑ‚Ñ€Ð°Ñ†Ð¸Ñ</button>
                </div>
                <div class="auth-form" id="auth-form">
                    <div class="auth-field" id="field-name" style="display:none;">
                        <label id="auth-label-name">Ð˜Ð¼Ñ</label>
                        <input type="text" id="auth-name" autocomplete="name">
                    </div>
                    <div class="auth-field">
                        <label id="auth-label-email">Email</label>
                        <input type="email" id="auth-email" autocomplete="email">
                    </div>
                    <div class="auth-field">
                        <label id="auth-label-password">ÐŸÐ°Ñ€Ð¾Ð»ÑŒ</label>
                        <input type="password" id="auth-password" autocomplete="current-password">
                    </div>
                    <div class="auth-error" id="auth-error"></div>
                    <button type="button" class="auth-submit-btn" id="auth-submit-btn">Ð’Ð¾Ð¹Ñ‚Ð¸</button>
                </div>
            </div>
        </div>

        <!-- Start Screen -->
        <div id="start-screen" class="start-screen">
            <h2 class="section-title" id="select-lesson-title">Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ ÑƒÑ€Ð¾Ðº</h2>
            <div class="lesson-grid" id="lesson-grid"></div>
        </div>

        <!-- Quiz View -->
        <div id="quiz-view" class="quiz-container">
            <div class="quiz-progress-bar-wrap">
                <div class="quiz-progress-bar-fill" id="quiz-progress-bar" style="width:0%"></div>
            </div>
            <div class="score-display">
                <div class="score-item">
                    <div class="score-label" id="label-q">Ð’Ð¾Ð¿Ñ€Ð¾Ñ</div>
                    <div class="score-value" id="progress-text">1 / 5</div>
                </div>
                <div class="score-item">
                    <div class="score-label" id="label-score">Ð¡Ñ‡ÐµÑ‚</div>
                    <div class="score-value" id="current-score-display">0</div>
                </div>
            </div>
            <div class="question-card">
                <div class="question-number" id="lesson-indicator">Ð£Ñ€Ð¾Ðº 1</div>
                <div class="japanese-word" id="word-display"></div>
            </div>
            <div class="options-container" id="options-container"></div>
            <button class="quiz-back-btn" id="quiz-back-btn">ÐÐ°Ð·Ð°Ð´</button>
        </div>

        <!-- Results View -->
        <div id="results-view" class="results-screen">
            <div class="results-card">
                <div class="result-header">
                    <h2 class="results-title" id="results-title">Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ñ‹</h2>
                </div>
                <div class="final-score" id="final-score">0%</div>
                <div class="final-score-label" id="final-score-label">ÐŸÑ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ñ‹Ñ… Ð¾Ñ‚Ð²ÐµÑ‚Ð¾Ð²</div>
                <div class="mistakes-container" id="mistakes-block">
                    <h3 class="mistakes-title" id="mistakes-title">
                        <span class="icon"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg></span>
                        Ð’Ð°ÑˆÐ¸ Ð¾ÑˆÐ¸Ð±ÐºÐ¸:
                    </h3>
                    <div class="mistakes-list" id="mistakes-list"></div>
                </div>
                <button class="restart-btn" id="restart-btn">Ð“Ð»Ð°Ð²Ð½Ð¾Ðµ Ð¼ÐµÐ½ÑŽ</button>
            </div>
        </div>

        <!-- Leaderboard View -->
        <div id="leaderboard-screen" class="leaderboard-screen">
            <div class="leaderboard-card">
                <h2 class="leaderboard-title" id="leaderboard-title">
                    <span class="icon"><svg viewBox="0 0 24 24"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5C7 4 7 7 7 7"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5C17 4 17 7 17 7"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></svg></span>
                    Ð ÐµÐ¹Ñ‚Ð¸Ð½Ð³ ÑƒÑ‡ÐµÐ½Ð¸ÐºÐ¾Ð²
                </h2>
                <div class="leaderboard-list" id="leaderboard-list"></div>
            </div>
            <button class="leaderboard-back-btn" id="leaderboard-back-btn">ÐÐ°Ð·Ð°Ð´</button>
        </div>

        <!-- Dictionary View -->
        <div id="dictionary-screen" class="dictionary-screen">
            <div class="dictionary-card">
                <h2 class="dictionary-title" id="dictionary-title">
                    <span class="icon"><svg viewBox="0 0 24 24"><path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20"/><path d="M8 7h6"/><path d="M8 11h4"/></svg></span>
                    Ð¡Ð»Ð¾Ð²Ð°Ñ€ÑŒ
                </h2>
                <div id="dictionary-breadcrumb" class="dict-breadcrumb"></div>
                <div id="dictionary-content"></div>
            </div>
            <button class="dictionary-back-btn" id="dictionary-back-btn">ÐÐ°Ð·Ð°Ð´</button>
        </div>
    </div>

    <!-- Feedback Modal -->
    <div class="modal-overlay" id="feedback-modal">
        <div class="modal-content">
            <div class="result-header">
                <div class="result-icon" id="feedback-icon"></div>
                <h3 class="result-title" id="feedback-status">Ð’ÐµÑ€Ð½Ð¾!</h3>
            </div>
            <div class="example-section">
                <div class="example-label" id="correct-label">ÐŸÑ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ñ‹Ð¹ Ð¾Ñ‚Ð²ÐµÑ‚</div>
                <div class="correct-answer-text">
                    <span id="correct-answer-text">Answer</span>
                </div>
            </div>
            <div class="example-section">
                <div class="example-label">ÐŸÑ€Ð¸Ð¼ÐµÑ€</div>
                <div class="example-jp" id="modal-example-jp"></div>
                <div class="example-translation" id="modal-example-trans"></div>
            </div>
            <div class="grammar-section">
                <div class="grammar-label" id="modal-grammar-label">
                    <span class="icon"><svg viewBox="0 0 24 24"><path d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 1 1 7.072 0l-.548.547A3.374 3.374 0 0 0 14 18.469V19a2 2 0 1 1-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/></svg></span>
                    Ð“Ñ€Ð°Ð¼Ð¼Ð°Ñ‚Ð¸ÐºÐ°
                </div>
                <div class="grammar-text" id="modal-grammar-text"></div>
            </div>
            <button class="next-btn" id="modal-next-btn" disabled>
                <span id="btn-text">Ð”Ð°Ð»ÐµÐµ</span>
                <div class="timer-bar" id="timer-bar" style="width: 0%"></div>
            </button>
        </div>
    </div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<script>
(function() {
    'use strict';

    // ============================================
    // SUPABASE CONFIG
    // ============================================
    const SUPABASE_URL = 'https://mlkiktunkjgiaribqwuq.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1sa2lrdHVua2pnaWFyaWJxd3VxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA2MTE3MTgsImV4cCI6MjA4NjE4NzcxOH0.64I8nlecs7R0M3oKlesfr8UsrRBHLgSSRb_wJcgpRDM';
    const MASTERY_THRESHOLD = 1;

    // ============================================
    // SVG ICON HELPERS
    // ============================================
    var ICONS = {
        check: '<span class="icon"><svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg></span>',
        x: '<span class="icon"><svg viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></span>',
        volumeOn: '<span class="icon"><svg viewBox="0 0 24 24"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/></svg></span>',
        volumeOff: '<span class="icon"><svg viewBox="0 0 24 24"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><line x1="23" y1="9" x2="17" y2="15"/><line x1="17" y1="9" x2="23" y2="15"/></svg></span>',
        book: '<span class="icon"><svg viewBox="0 0 24 24"><path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20"/><path d="M8 7h6"/><path d="M8 11h4"/></svg></span>',
        chevronRight: '<span class="icon"><svg viewBox="0 0 24 24"><polyline points="9 18 15 12 9 6"/></svg></span>',
        layers: '<span class="icon"><svg viewBox="0 0 24 24"><polygon points="12 2 2 7 12 12 22 7 12 2"/><polyline points="2 17 12 22 22 17"/><polyline points="2 12 12 17 22 12"/></svg></span>',
        lightbulb: '<span class="icon"><svg viewBox="0 0 24 24"><path d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 1 1 7.072 0l-.548.547A3.374 3.374 0 0 0 14 18.469V19a2 2 0 1 1-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/></svg></span>'
    };

    // ============================================
    // SAFE SUPABASE INIT
    // ============================================
    let sb = null;
    let supabaseReady = false;

    function initSupabase() {
        try {
            if (typeof window.supabase === 'undefined' || !window.supabase.createClient) {
                return false;
            }
            if (!SUPABASE_URL || SUPABASE_URL.includes('abcdefghij') ||
                !SUPABASE_ANON_KEY || SUPABASE_ANON_KEY === 'YOUR_SUPABASE_ANON_KEY') {
                return false;
            }
            sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
                auth: {
                    persistSession: true,        // ÑÐµÑÑÐ¸Ñ ÑÐ¾Ñ…Ñ€Ð°Ð½ÑÐµÑ‚ÑÑ Ð² localStorage Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸
                    autoRefreshToken: true,       // refresh-Ñ‚Ð¾ÐºÐµÐ½ Ð¾Ð±Ð½Ð¾Ð²Ð»ÑÐµÑ‚ÑÑ Ð´Ð¾ Ð¸ÑÑ‚ÐµÑ‡ÐµÐ½Ð¸Ñ ÑÑ€Ð¾ÐºÐ°
                    detectSessionInUrl: true,     // Ð¿Ð¾Ð´Ñ…Ð²Ð°Ñ‚Ñ‹Ð²Ð°ÐµÑ‚ OAuth-callback Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ñ‹ Ð¸Ð· URL
                    storageKey: 'mnq-auth-token', // ÑƒÐ½Ð¸ÐºÐ°Ð»ÑŒÐ½Ñ‹Ð¹ ÐºÐ»ÑŽÑ‡, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð½Ðµ ÐºÐ¾Ð½Ñ„Ð»Ð¸ÐºÑ‚Ð¾Ð²Ð°Ñ‚ÑŒ Ñ Ð´Ñ€ÑƒÐ³Ð¸Ð¼Ð¸ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸ÑÐ¼Ð¸
                    storage: window.localStorage  // ÑÐ²Ð½Ð¾Ðµ ÑƒÐºÐ°Ð·Ð°Ð½Ð¸Ðµ Ñ…Ñ€Ð°Ð½Ð¸Ð»Ð¸Ñ‰Ð°
                }
            });
            supabaseReady = true;
            return true;
        } catch (e) {
            return false;
        }
    }

    // ============================================
    // AUTH STATE LISTENER (onAuthStateChange)
    // ============================================
    let authSubscription = null;

    function setupAuthListener() {
        if (!supabaseReady || !sb) return;

        // ÐŸÐ¾Ð´Ð¿Ð¸ÑÐºÐ° Ð½Ð° Ð²ÑÐµ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ñ Ð°ÑƒÑ‚ÐµÐ½Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ†Ð¸Ð¸
        var { data } = sb.auth.onAuthStateChange(async function(event, session) {
            // Auth event handled silently (no console logging in production)

            switch (event) {
                // â€”â€”â€” ÐÐ°Ñ‡Ð°Ð»ÑŒÐ½Ð°Ñ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ°: ÑÐµÑÑÐ¸Ñ Ð²Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð° Ð¸Ð· localStorage (F5, Ð½Ð¾Ð²Ð°Ñ Ð²ÐºÐ»Ð°Ð´ÐºÐ°) â€”â€”â€”
                case 'INITIAL_SESSION':
                    if (session && session.user) {
                        state.user = session.user;
                        await onAuthSuccess();
                    } else {
                        // ÐÐµÑ‚ ÑÐ¾Ñ…Ñ€Ð°Ð½Ñ‘Ð½Ð½Ð¾Ð¹ ÑÐµÑÑÐ¸Ð¸ â€” Ð¿Ð¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ Ð»Ð¾Ð³Ð¸Ð½
                        resetToAuthScreen();
                    }
                    break;

                // â€”â€”â€” ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð·Ð°Ð»Ð¾Ð³Ð¸Ð½Ð¸Ð»ÑÑ â€”â€”â€”
                case 'SIGNED_IN':
                    // ÐžÐ±Ñ€Ð°Ð±Ð°Ñ‚Ñ‹Ð²Ð°ÐµÐ¼ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ ÐµÑÐ»Ð¸ user ÐµÑ‰Ñ‘ Ð½Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½ (Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð½Ðµ Ð´ÑƒÐ±Ð»Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ handleAuthSubmit)
                    if (!state.user && session && session.user) {
                        state.user = session.user;
                        await onAuthSuccess();
                    }
                    break;

                // â€”â€”â€” ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð²Ñ‹ÑˆÐµÐ» / ÑÐµÑÑÐ¸Ñ Ð±Ñ‹Ð»Ð° invalidated â€”â€”â€”
                case 'SIGNED_OUT':
                    resetToAuthScreen();
                    break;

                // â€”â€”â€” Access-Ñ‚Ð¾ÐºÐµÐ½ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð¾Ð±Ð½Ð¾Ð²Ð»Ñ‘Ð½ Ñ‡ÐµÑ€ÐµÐ· refresh-Ñ‚Ð¾ÐºÐµÐ½ â€”â€”â€”
                case 'TOKEN_REFRESHED':
                    if (session && session.user) {
                        state.user = session.user; // Ð¾Ð±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ð¾Ð±ÑŠÐµÐºÑ‚ user Ð½Ð° ÑÐ»ÑƒÑ‡Ð°Ð¹ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ð¹
                    }
                    break;

                // â€”â€”â€” Ð”Ð°Ð½Ð½Ñ‹Ðµ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ Ð¾Ð±Ð½Ð¾Ð²Ð¸Ð»Ð¸ÑÑŒ (Ð¼ÐµÑ‚Ð°Ð´Ð°Ð½Ð½Ñ‹Ðµ, email Ð¸ Ñ‚.Ð´.) â€”â€”â€”
                case 'USER_UPDATED':
                    if (session && session.user) {
                        state.user = session.user;
                        // ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ð¸Ð¼Ñ Ð½Ð° ÑÐ»ÑƒÑ‡Ð°Ð¹ ÐµÑÐ»Ð¸ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ ÑÐ¼ÐµÐ½Ð¸Ð» display_name
                        var dn = session.user.user_metadata && session.user.user_metadata.display_name;
                        if (dn) els.headerUserName.textContent = dn;
                    }
                    break;

                // â€”â€”â€” ÐŸÐ°Ñ€Ð¾Ð»ÑŒ Ð²Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½ Ñ‡ÐµÑ€ÐµÐ· email-ÑÑÑ‹Ð»ÐºÑƒ â€”â€”â€”
                case 'PASSWORD_RECOVERY':
                    // ÐœÐ¾Ð¶Ð½Ð¾ Ð¿Ð¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ Ñ„Ð¾Ñ€Ð¼Ñƒ ÑÐ¼ÐµÐ½Ñ‹ Ð¿Ð°Ñ€Ð¾Ð»Ñ; Ð¿Ð¾ÐºÐ° Ð¿Ñ€Ð¾ÑÑ‚Ð¾ Ð»Ð¾Ð³Ð¸Ñ€ÑƒÐµÐ¼
                    // Password recovery flow detected â€” could show password change form
                    break;
            }
        });

        authSubscription = data.subscription;
    }

    function resetToAuthScreen() {
        state.user = null;
        state.userProgress = {};
        showHeaderButtons(false);
        showScreen('auth');
        updateAuthLabels();
    }

    // ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° Ð¿Ð¾Ð´Ð¿Ð¸ÑÐºÐ¸ (Ð²Ñ‹Ð·Ñ‹Ð²Ð°ÐµÑ‚ÑÑ Ð¿Ñ€Ð¸ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ð¾ÑÑ‚Ð¸: SPA-Ñ€Ð¾ÑƒÑ‚Ð¸Ð½Ð³, unmount)
    function teardownAuthListener() {
        if (authSubscription) {
            authSubscription.unsubscribe();
            authSubscription = null;
        }
    }

    // ============================================
    // WORD DATA
    // ============================================
    const wordsData = [
        {
            id: 1, lesson: 1,
            japanese: "<ruby>ç§<rt>ã‚ãŸã—</rt></ruby>",
            cleanWord: "ç§",
            translations: { ru: "Ñ", uz: "men" },
            exampleSentences: {
                ru: {
                    jp: "<ruby>ç§<rt>ã‚ãŸã—</rt></ruby>ã¯ ãƒžã‚¤ã‚¯ãƒ»ãƒŸãƒ©ãƒ¼ã§ã™ã€‚",
                    translation: "Ð¯ â€” ÐœÐ°Ð¹Ðº ÐœÐ¸Ð»Ð»ÐµÑ€.",
                    grammarInfo: "ã€ÐŸÐ¾Ð»Ð½Ñ‹Ð¹ Ñ€Ð°Ð·Ð±Ð¾Ñ€ã€‘\n\n1. ç§ã¯ â€” Â«ÑÂ» + Ñ‡Ð°ÑÑ‚Ð¸Ñ†Ð° Ñ‚ÐµÐ¼Ñ‹ ã¯ (Ñ‡Ð¸Ñ‚Ð°ÐµÑ‚ÑÑ Â«waÂ»). ÐžÐ½Ð° Ð²Ñ‹Ð´ÐµÐ»ÑÐµÑ‚ Ñ‚Ð¾Ð³Ð¾, Ð¾ ÐºÐ¾Ð¼ Ð¸Ð´ÐµÑ‚ Ñ€ÐµÑ‡ÑŒ.\n2. ãƒžã‚¤ã‚¯ãƒ»ãƒŸãƒ©ãƒ¼ã§ã™ â€” Ð¸Ð¼Ñ + ÑÐ²ÑÐ·ÐºÐ° ã§ã™. ã§ã™ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚ ÐºÐ°Ðº Ð·Ð½Ð°Ðº Ñ€Ð°Ð²ÐµÐ½ÑÑ‚Ð²Ð° (=).\n\nã€Ð›Ð¾Ð²ÑƒÑˆÐºÐ°ã€‘: ÐÐµ Ð³Ð¾Ð²Ð¾Ñ€Ð¸Ñ‚Ðµ Â«Watashi wa Miller-san desuÂ». Ð¡Ð°Ð½ (san) Ðº ÑÐµÐ±Ðµ Ð½Ðµ Ð´Ð¾Ð±Ð°Ð²Ð»ÑÑŽÑ‚!\nã€ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒ ÑÐµÐ±Ñã€‘: ÐšÑ‚Ð¾ ÑÐ²Ð»ÑÐµÑ‚ÑÑ Ñ‚ÐµÐ¼Ð¾Ð¹ Ð¿Ñ€ÐµÐ´Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ?"
                },
                uz: {
                    jp: "<ruby>ç§<rt>ã‚ãŸã—</rt></ruby>ã¯ ãƒžã‚¤ã‚¯ãƒ»ãƒŸãƒ©ãƒ¼ã§ã™ã€‚",
                    translation: "Men Mayk Millerman.",
                    grammarInfo: "ã€To'liq tahlilã€‘\n\n1. ç§ã¯ â€” Â«menÂ» + mavzu yuklamasi ã¯ (Â«waÂ» deb o'qiladi). U kim haqida gap ketayotganini ko'rsatadi.\n2. ãƒžã‚¤ã‚¯ãƒ»ãƒŸãƒ©ãƒ¼ã§ã™ â€” ism + bog'lovchi ã§ã™. ã§ã™ tenglik belgisi (=) kabi ishlaydi.\n\nã€Tuzoqã€‘: Â«Watashi wa Miller-san desuÂ» demang. O'z ismingizga Â«sanÂ» qo'shilmaydi!\nã€O'zingni tekshirã€‘: Gapning mavzusi kim?"
                }
            },
            dictionaryExamples: {
                ru: [
                    { jp: "<ruby>ç§<rt>ã‚ãŸã—</rt></ruby>ã¯ ãƒžã‚¤ã‚¯ãƒ»ãƒŸãƒ©ãƒ¼ã§ã™ã€‚", translation: "Ð¯ â€” ÐœÐ°Ð¹Ðº ÐœÐ¸Ð»Ð»ÐµÑ€." },
                    { jp: "<ruby>ç§<rt>ã‚ãŸã—</rt></ruby>ã¯ <ruby>å­¦ç”Ÿ<rt>ãŒãã›ã„</rt></ruby>ã§ã™ã€‚", translation: "Ð¯ â€” ÑÑ‚ÑƒÐ´ÐµÐ½Ñ‚." },
                    { jp: "<ruby>ç§<rt>ã‚ãŸã—</rt></ruby>ã¯ <ruby>æ—¥æœ¬äºº<rt>ã«ã»ã‚“ã˜ã‚“</rt></ruby>ã˜ã‚ƒ ã‚ã‚Šã¾ã›ã‚“ã€‚", translation: "Ð¯ Ð½Ðµ ÑÐ¿Ð¾Ð½ÐµÑ†." }
                ],
                uz: [
                    { jp: "<ruby>ç§<rt>ã‚ãŸã—</rt></ruby>ã¯ ãƒžã‚¤ã‚¯ãƒ»ãƒŸãƒ©ãƒ¼ã§ã™ã€‚", translation: "Men Mayk Millerman." },
                    { jp: "<ruby>ç§<rt>ã‚ãŸã—</rt></ruby>ã¯ <ruby>å­¦ç”Ÿ<rt>ãŒãã›ã„</rt></ruby>ã§ã™ã€‚", translation: "Men talabaman." },
                    { jp: "<ruby>ç§<rt>ã‚ãŸã—</rt></ruby>ã¯ <ruby>æ—¥æœ¬äºº<rt>ã«ã»ã‚“ã˜ã‚“</rt></ruby>ã˜ã‚ƒ ã‚ã‚Šã¾ã›ã‚“ã€‚", translation: "Men yapon emasman." }
                ]
            }
        },
        {
            id: 2, lesson: 1,
            japanese: "<ruby>ç§<rt>ã‚ãŸã—</rt></ruby>ãŸã¡",
            cleanWord: "ç§ãŸã¡",
            translations: { ru: "Ð¼Ñ‹", uz: "biz" },
            exampleSentences: {
                ru: {
                    jp: "<ruby>ç§<rt>ã‚ãŸã—</rt></ruby>ãŸã¡ã¯ <ruby>å­¦ç”Ÿ<rt>ãŒãã›ã„</rt></ruby>ã§ã™ã€‚",
                    translation: "ÐœÑ‹ â€” ÑÑ‚ÑƒÐ´ÐµÐ½Ñ‚Ñ‹.",
                    grammarInfo: "ã€Ð Ð°Ð·Ð±Ð¾Ñ€ã€‘\n\n1. ç§ãŸã¡ â€” Â«Ð¼Ñ‹Â» (ç§ + ãŸã¡ â€” ÑÑƒÑ„Ñ„Ð¸ÐºÑ Ð¼Ð½Ð¾Ð¶ÐµÑÑ‚Ð²ÐµÐ½Ð½Ð¾Ð³Ð¾ Ñ‡Ð¸ÑÐ»Ð°).\n2. å­¦ç”Ÿã§ã™ â€” Â«ÑÑ‚ÑƒÐ´ÐµÐ½Ñ‚Ñ‹Â» + ÑÐ²ÑÐ·ÐºÐ° ã§ã™."
                },
                uz: {
                    jp: "<ruby>ç§<rt>ã‚ãŸã—</rt></ruby>ãŸã¡ã¯ <ruby>å­¦ç”Ÿ<rt>ãŒãã›ã„</rt></ruby>ã§ã™ã€‚",
                    translation: "Biz talabamiz.",
                    grammarInfo: "ã€Tahlilã€‘\n\n1. ç§ãŸã¡ â€” Â«bizÂ» (ç§ + ãŸã¡ â€” ko'plik qo'shimchasi).\n2. å­¦ç”Ÿã§ã™ â€” Â«talabaÂ» + bog'lovchi ã§ã™."
                }
            },
            dictionaryExamples: {
                ru: [
                    { jp: "<ruby>ç§<rt>ã‚ãŸã—</rt></ruby>ãŸã¡ã¯ <ruby>å­¦ç”Ÿ<rt>ãŒãã›ã„</rt></ruby>ã§ã™ã€‚", translation: "ÐœÑ‹ â€” ÑÑ‚ÑƒÐ´ÐµÐ½Ñ‚Ñ‹." },
                    { jp: "<ruby>ç§<rt>ã‚ãŸã—</rt></ruby>ãŸã¡ã¯ <ruby>æ—¥æœ¬äºº<rt>ã«ã»ã‚“ã˜ã‚“</rt></ruby>ã˜ã‚ƒ ã‚ã‚Šã¾ã›ã‚“ã€‚", translation: "ÐœÑ‹ Ð½Ðµ ÑÐ¿Ð¾Ð½Ñ†Ñ‹." },
                    { jp: "<ruby>ç§<rt>ã‚ãŸã—</rt></ruby>ãŸã¡ã¯ IMCã® <ruby>ç¤¾å“¡<rt>ã—ã‚ƒã„ã‚“</rt></ruby>ã§ã™ã€‚", translation: "ÐœÑ‹ â€” ÑÐ¾Ñ‚Ñ€ÑƒÐ´Ð½Ð¸ÐºÐ¸ IMC." }
                ],
                uz: [
                    { jp: "<ruby>ç§<rt>ã‚ãŸã—</rt></ruby>ãŸã¡ã¯ <ruby>å­¦ç”Ÿ<rt>ãŒãã›ã„</rt></ruby>ã§ã™ã€‚", translation: "Biz talabamiz." },
                    { jp: "<ruby>ç§<rt>ã‚ãŸã—</rt></ruby>ãŸã¡ã¯ <ruby>æ—¥æœ¬äºº<rt>ã«ã»ã‚“ã˜ã‚“</rt></ruby>ã˜ã‚ƒ ã‚ã‚Šã¾ã›ã‚“ã€‚", translation: "Biz yapon emasmiz." },
                    { jp: "<ruby>ç§<rt>ã‚ãŸã—</rt></ruby>ãŸã¡ã¯ IMCã® <ruby>ç¤¾å“¡<rt>ã—ã‚ƒã„ã‚“</rt></ruby>ã§ã™ã€‚", translation: "Biz IMC xodimlarmiz." }
                ]
            }
        },
        {
            id: 3, lesson: 1,
            japanese: "<ruby>ã‚ãªãŸ</ruby>",
            cleanWord: "ã‚ãªãŸ",
            translations: { ru: "Ð²Ñ‹, Ñ‚Ñ‹", uz: "siz, sen" },
            exampleSentences: {
                ru: {
                    jp: "ã‚ãªãŸã¯ <ruby>å…ˆç”Ÿ<rt>ã›ã‚“ã›ã„</rt></ruby>ã§ã™ã‹ã€‚",
                    translation: "Ð’Ñ‹ â€” ÑƒÑ‡Ð¸Ñ‚ÐµÐ»ÑŒ?",
                    grammarInfo: "ã€Ð Ð°Ð·Ð±Ð¾Ñ€ã€‘\n\n1. ã‚ãªãŸã¯ â€” Â«Ð²Ñ‹Â» + ã¯.\n2. å…ˆç”Ÿã§ã™ã‹ â€” Â«ÑƒÑ‡Ð¸Ñ‚ÐµÐ»ÑŒÂ» + ã§ã™ + ã‹ (Ð²Ð¾Ð¿Ñ€Ð¾ÑÐ¸Ñ‚ÐµÐ»ÑŒÐ½Ð°Ñ Ñ‡Ð°ÑÑ‚Ð¸Ñ†Ð°).\n\nã€Ð’Ð½Ð¸Ð¼Ð°Ð½Ð¸Ðµã€‘: Ð’ ÑÐ¿Ð¾Ð½ÑÐºÐ¾Ð¼ ã‚ãªãŸ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ÑÑ Ñ€ÐµÐ´ÐºÐ¾. Ð›ÑƒÑ‡ÑˆÐµ Ð¾Ð±Ñ€Ð°Ñ‰Ð°Ñ‚ÑŒÑÑ Ð¿Ð¾ Ð¸Ð¼ÐµÐ½Ð¸!"
                },
                uz: {
                    jp: "ã‚ãªãŸã¯ <ruby>å…ˆç”Ÿ<rt>ã›ã‚“ã›ã„</rt></ruby>ã§ã™ã‹ã€‚",
                    translation: "Siz o'qituvchimisiz?",
                    grammarInfo: "ã€Tahlilã€‘\n\n1. ã‚ãªãŸã¯ â€” Â«sizÂ» + ã¯.\n2. å…ˆç”Ÿã§ã™ã‹ â€” Â«o'qituvchiÂ» + ã§ã™ + ã‹ (so'roq yuklamasi).\n\nã€Diqqatã€‘: Yapon tilida ã‚ãªãŸ kam ishlatiladi. Ism bilan murojaat qilish yaxshiroq!"
                }
            },
            dictionaryExamples: {
                ru: [
                    { jp: "ã‚ãªãŸã¯ <ruby>å…ˆç”Ÿ<rt>ã›ã‚“ã›ã„</rt></ruby>ã§ã™ã‹ã€‚", translation: "Ð’Ñ‹ â€” ÑƒÑ‡Ð¸Ñ‚ÐµÐ»ÑŒ?" },
                    { jp: "ã‚ãªãŸã¯ <ruby>ä½•æ­³<rt>ãªã‚“ã•ã„</rt></ruby>ã§ã™ã‹ã€‚", translation: "Ð¡ÐºÐ¾Ð»ÑŒÐºÐ¾ Ð²Ð°Ð¼ Ð»ÐµÑ‚?" },
                    { jp: "ã‚ãªãŸã‚‚ <ruby>å­¦ç”Ÿ<rt>ãŒãã›ã„</rt></ruby>ã§ã™ã‹ã€‚", translation: "Ð’Ñ‹ Ñ‚Ð¾Ð¶Ðµ ÑÑ‚ÑƒÐ´ÐµÐ½Ñ‚?" }
                ],
                uz: [
                    { jp: "ã‚ãªãŸã¯ <ruby>å…ˆç”Ÿ<rt>ã›ã‚“ã›ã„</rt></ruby>ã§ã™ã‹ã€‚", translation: "Siz o'qituvchimisiz?" },
                    { jp: "ã‚ãªãŸã¯ <ruby>ä½•æ­³<rt>ãªã‚“ã•ã„</rt></ruby>ã§ã™ã‹ã€‚", translation: "Yoshingiz nechada?" },
                    { jp: "ã‚ãªãŸã‚‚ <ruby>å­¦ç”Ÿ<rt>ãŒãã›ã„</rt></ruby>ã§ã™ã‹ã€‚", translation: "Siz ham talabamisiz?" }
                ]
            }
        },
        {
            id: 4, lesson: 1,
            japanese: "<ruby>å…ˆç”Ÿ<rt>ã›ã‚“ã›ã„</rt></ruby>",
            cleanWord: "å…ˆç”Ÿ",
            translations: { ru: "ÑƒÑ‡Ð¸Ñ‚ÐµÐ»ÑŒ, Ð¿Ñ€ÐµÐ¿Ð¾Ð´Ð°Ð²Ð°Ñ‚ÐµÐ»ÑŒ", uz: "o'qituvchi, ustoz" },
            exampleSentences: {
                ru: {
                    jp: "ãƒ¯ãƒƒãƒˆ<ruby>å…ˆç”Ÿ<rt>ã›ã‚“ã›ã„</rt></ruby>ã¯ ã‚¤ã‚®ãƒªã‚¹<ruby>äºº<rt>ã˜ã‚“</rt></ruby>ã§ã™ã€‚",
                    translation: "Ð£Ñ‡Ð¸Ñ‚ÐµÐ»ÑŒ Ð’Ð°Ñ‚Ñ‚ â€” Ð°Ð½Ð³Ð»Ð¸Ñ‡Ð°Ð½Ð¸Ð½.",
                    grammarInfo: "ã€Ð Ð°Ð·Ð±Ð¾Ñ€ã€‘\n\n1. ãƒ¯ãƒƒãƒˆå…ˆç”Ÿ â€” Ð¸Ð¼Ñ + å…ˆç”Ÿ (ÑƒÐ²Ð°Ð¶Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾Ðµ Ð¾Ð±Ñ€Ð°Ñ‰ÐµÐ½Ð¸Ðµ Ðº ÑƒÑ‡Ð¸Ñ‚ÐµÐ»ÑŽ).\n2. ã‚¤ã‚®ãƒªã‚¹äººã§ã™ â€” Â«Ð°Ð½Ð³Ð»Ð¸Ñ‡Ð°Ð½Ð¸Ð½Â» + ã§ã™."
                },
                uz: {
                    jp: "ãƒ¯ãƒƒãƒˆ<ruby>å…ˆç”Ÿ<rt>ã›ã‚“ã›ã„</rt></ruby>ã¯ ã‚¤ã‚®ãƒªã‚¹<ruby>äºº<rt>ã˜ã‚“</rt></ruby>ã§ã™ã€‚",
                    translation: "Vatt sensei â€” ingliz.",
                    grammarInfo: "ã€Tahlilã€‘\n\n1. ãƒ¯ãƒƒãƒˆå…ˆç”Ÿ â€” ism + å…ˆç”Ÿ (o'qituvchiga hurmatli murojaat).\n2. ã‚¤ã‚®ãƒªã‚¹äººã§ã™ â€” Â«inglizÂ» + ã§ã™."
                }
            },
            dictionaryExamples: {
                ru: [
                    { jp: "ãƒ¯ãƒƒãƒˆ<ruby>å…ˆç”Ÿ<rt>ã›ã‚“ã›ã„</rt></ruby>ã¯ ã‚¤ã‚®ãƒªã‚¹<ruby>äºº<rt>ã˜ã‚“</rt></ruby>ã§ã™ã€‚", translation: "Ð£Ñ‡Ð¸Ñ‚ÐµÐ»ÑŒ Ð’Ð°Ñ‚Ñ‚ â€” Ð°Ð½Ð³Ð»Ð¸Ñ‡Ð°Ð½Ð¸Ð½." },
                    { jp: "<ruby>å…ˆç”Ÿ<rt>ã›ã‚“ã›ã„</rt></ruby>ã¯ <ruby>æ—¥æœ¬äºº<rt>ã«ã»ã‚“ã˜ã‚“</rt></ruby>ã§ã™ã‹ã€‚", translation: "Ð£Ñ‡Ð¸Ñ‚ÐµÐ»ÑŒ â€” ÑÐ¿Ð¾Ð½ÐµÑ†?" },
                    { jp: "<ruby>å±±ç”°<rt>ã‚„ã¾ã </rt></ruby><ruby>å…ˆç”Ÿ<rt>ã›ã‚“ã›ã„</rt></ruby>ã¯ <ruby>å¤§å­¦<rt>ã ã„ãŒã</rt></ruby>ã® <ruby>å…ˆç”Ÿ<rt>ã›ã‚“ã›ã„</rt></ruby>ã§ã™ã€‚", translation: "Ð¯Ð¼Ð°Ð´Ð°-ÑÑÐ½ÑÑÐ¹ â€” Ð¿Ñ€ÐµÐ¿Ð¾Ð´Ð°Ð²Ð°Ñ‚ÐµÐ»ÑŒ ÑƒÐ½Ð¸Ð²ÐµÑ€ÑÐ¸Ñ‚ÐµÑ‚Ð°." }
                ],
                uz: [
                    { jp: "ãƒ¯ãƒƒãƒˆ<ruby>å…ˆç”Ÿ<rt>ã›ã‚“ã›ã„</rt></ruby>ã¯ ã‚¤ã‚®ãƒªã‚¹<ruby>äºº<rt>ã˜ã‚“</rt></ruby>ã§ã™ã€‚", translation: "Vatt sensei â€” ingliz." },
                    { jp: "<ruby>å…ˆç”Ÿ<rt>ã›ã‚“ã›ã„</rt></ruby>ã¯ <ruby>æ—¥æœ¬äºº<rt>ã«ã»ã‚“ã˜ã‚“</rt></ruby>ã§ã™ã‹ã€‚", translation: "Sensei yaponmi?" },
                    { jp: "<ruby>å±±ç”°<rt>ã‚„ã¾ã </rt></ruby><ruby>å…ˆç”Ÿ<rt>ã›ã‚“ã›ã„</rt></ruby>ã¯ <ruby>å¤§å­¦<rt>ã ã„ãŒã</rt></ruby>ã® <ruby>å…ˆç”Ÿ<rt>ã›ã‚“ã›ã„</rt></ruby>ã§ã™ã€‚", translation: "Yamada sensei â€” universitet o'qituvchisi." }
                ]
            }
        },
        {
            id: 5, lesson: 1,
            japanese: "<ruby>å­¦ç”Ÿ<rt>ãŒãã›ã„</rt></ruby>",
            cleanWord: "å­¦ç”Ÿ",
            translations: { ru: "ÑÑ‚ÑƒÐ´ÐµÐ½Ñ‚", uz: "talaba" },
            exampleSentences: {
                ru: {
                    jp: "ãƒžã‚¤ã‚¯ã•ã‚“ã¯ <ruby>å­¦ç”Ÿ<rt>ãŒãã›ã„</rt></ruby>ã§ã™ã€‚",
                    translation: "ÐœÐ°Ð¹Ðº â€” ÑÑ‚ÑƒÐ´ÐµÐ½Ñ‚.",
                    grammarInfo: "ã€Ð Ð°Ð·Ð±Ð¾Ñ€ã€‘\n\n1. ãƒžã‚¤ã‚¯ã•ã‚“ â€” Ð¸Ð¼Ñ + ã•ã‚“ (Ð²ÐµÐ¶Ð»Ð¸Ð²Ñ‹Ð¹ ÑÑƒÑ„Ñ„Ð¸ÐºÑ).\n2. å­¦ç”Ÿã§ã™ â€” Â«ÑÑ‚ÑƒÐ´ÐµÐ½Ñ‚Â» + ã§ã™."
                },
                uz: {
                    jp: "ãƒžã‚¤ã‚¯ã•ã‚“ã¯ <ruby>å­¦ç”Ÿ<rt>ãŒãã›ã„</rt></ruby>ã§ã™ã€‚",
                    translation: "Mayk talaba.",
                    grammarInfo: "ã€Tahlilã€‘\n\n1. ãƒžã‚¤ã‚¯ã•ã‚“ â€” ism + ã•ã‚“ (hurmatli qo'shimcha).\n2. å­¦ç”Ÿã§ã™ â€” Â«talabaÂ» + ã§ã™."
                }
            },
            dictionaryExamples: {
                ru: [
                    { jp: "ãƒžã‚¤ã‚¯ã•ã‚“ã¯ <ruby>å­¦ç”Ÿ<rt>ãŒãã›ã„</rt></ruby>ã§ã™ã€‚", translation: "ÐœÐ°Ð¹Ðº â€” ÑÑ‚ÑƒÐ´ÐµÐ½Ñ‚." },
                    { jp: "<ruby>å­¦ç”Ÿ<rt>ãŒãã›ã„</rt></ruby>ã˜ã‚ƒ ã‚ã‚Šã¾ã›ã‚“ã€‚", translation: "Ð¯ Ð½Ðµ ÑÑ‚ÑƒÐ´ÐµÐ½Ñ‚." },
                    { jp: "ã‚µãƒ³ãƒˆã‚¹ã•ã‚“ã‚‚ <ruby>å­¦ç”Ÿ<rt>ãŒãã›ã„</rt></ruby>ã§ã™ã‹ã€‚", translation: "Ð¡Ð°Ð½Ñ‚Ð¾Ñ Ñ‚Ð¾Ð¶Ðµ ÑÑ‚ÑƒÐ´ÐµÐ½Ñ‚?" }
                ],
                uz: [
                    { jp: "ãƒžã‚¤ã‚¯ã•ã‚“ã¯ <ruby>å­¦ç”Ÿ<rt>ãŒãã›ã„</rt></ruby>ã§ã™ã€‚", translation: "Mayk talaba." },
                    { jp: "<ruby>å­¦ç”Ÿ<rt>ãŒãã›ã„</rt></ruby>ã˜ã‚ƒ ã‚ã‚Šã¾ã›ã‚“ã€‚", translation: "Men talaba emasman." },
                    { jp: "ã‚µãƒ³ãƒˆã‚¹ã•ã‚“ã‚‚ <ruby>å­¦ç”Ÿ<rt>ãŒãã›ã„</rt></ruby>ã§ã™ã‹ã€‚", translation: "Santos ham talabami?" }
                ]
            }
        }
    ];

    // ============================================
    // LOCALIZATION
    // ============================================
    const uiTexts = {
        ru: {
            title: "Minna no Nihongo",
            selectLesson: "Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ ÑƒÑ€Ð¾Ðº",
            allLessons: "Ð’ÑÐµ ÑƒÑ€Ð¾ÐºÐ¸",
            lessonPrefix: "Ð£Ñ€Ð¾Ðº",
            question: "Ð’Ð¾Ð¿Ñ€Ð¾Ñ",
            score: "Ð¡Ñ‡ÐµÑ‚",
            nextBtn: "Ð”Ð°Ð»ÐµÐµ",
            wait: "Ð–Ð´Ð¸Ñ‚Ðµ",
            grammarLabel: "Ð“Ñ€Ð°Ð¼Ð¼Ð°Ñ‚Ð¸ÐºÐ°",
            correct: "Ð’ÐµÑ€Ð½Ð¾!",
            incorrect: "ÐžÑˆÐ¸Ð±ÐºÐ°",
            correctAnswerIs: "ÐŸÑ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ñ‹Ð¹ Ð¾Ñ‚Ð²ÐµÑ‚:",
            results: "Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ñ‹",
            mainMenu: "Ð“Ð»Ð°Ð²Ð½Ð¾Ðµ Ð¼ÐµÐ½ÑŽ",
            mistakesTitle: "Ð’Ð°ÑˆÐ¸ Ð¾ÑˆÐ¸Ð±ÐºÐ¸:",
            scoreLabel: "ÐŸÑ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ñ‹Ñ… Ð¾Ñ‚Ð²ÐµÑ‚Ð¾Ð²",
            login: "Ð’Ð¾Ð¹Ñ‚Ð¸",
            register: "Ð ÐµÐ³Ð¸ÑÑ‚Ñ€Ð°Ñ†Ð¸Ñ",
            name: "Ð˜Ð¼Ñ",
            email: "Email",
            password: "ÐŸÐ°Ñ€Ð¾Ð»ÑŒ",
            loginBtn: "Ð’Ð¾Ð¹Ñ‚Ð¸",
            registerBtn: "Ð¡Ð¾Ð·Ð´Ð°Ñ‚ÑŒ Ð°ÐºÐºÐ°ÑƒÐ½Ñ‚",
            logout: "Ð’Ñ‹Ð¹Ñ‚Ð¸",
            errEmailRequired: "Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ email",
            errPasswordRequired: "Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ð¿Ð°Ñ€Ð¾Ð»ÑŒ (Ð¼Ð¸Ð½. 6 ÑÐ¸Ð¼Ð²Ð¾Ð»Ð¾Ð²)",
            errNameRequired: "Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ð²Ð°ÑˆÐµ Ð¸Ð¼Ñ",
            errInvalidCreds: "ÐÐµÐ²ÐµÑ€Ð½Ñ‹Ð¹ email Ð¸Ð»Ð¸ Ð¿Ð°Ñ€Ð¾Ð»ÑŒ",
            errEmailTaken: "Ð­Ñ‚Ð¾Ñ‚ email ÑƒÐ¶Ðµ Ð·Ð°Ñ€ÐµÐ³Ð¸ÑÑ‚Ñ€Ð¸Ñ€Ð¾Ð²Ð°Ð½",
            errGeneric: "ÐŸÑ€Ð¾Ð¸Ð·Ð¾ÑˆÐ»Ð° Ð¾ÑˆÐ¸Ð±ÐºÐ°. ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ ÐµÑ‰Ñ‘ Ñ€Ð°Ð·.",
            leaderboardTitle: "Ð ÐµÐ¹Ñ‚Ð¸Ð½Ð³ ÑƒÑ‡ÐµÐ½Ð¸ÐºÐ¾Ð²",
            leaderboardEmpty: "ÐŸÐ¾ÐºÐ° Ð½ÐµÑ‚ Ð´Ð°Ð½Ð½Ñ‹Ñ…. ÐÐ°Ñ‡Ð½Ð¸Ñ‚Ðµ ÑƒÑ‡Ð¸Ñ‚ÑŒ ÑÐ»Ð¾Ð²Ð°!",
            leaderboardOffline: "Ð ÐµÐ¹Ñ‚Ð¸Ð½Ð³ Ð´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð² Ð¾Ð½Ð»Ð°Ð¹Ð½-Ñ€ÐµÐ¶Ð¸Ð¼Ðµ",
            back: "ÐÐ°Ð·Ð°Ð´",
            wordsLabel: "ÑÐ»Ð¾Ð²",
            dictionary: "Ð¡Ð»Ð¾Ð²Ð°Ñ€ÑŒ",
            wordsCount: "ÑÐ»Ð¾Ð²",
            examples: "ÐŸÑ€Ð¸Ð¼ÐµÑ€Ñ‹",
            grammarNote: "Ð“Ñ€Ð°Ð¼Ð¼Ð°Ñ‚Ð¸ÐºÐ°"
        },
        uz: {
            title: "Minna no Nihongo",
            selectLesson: "Darsni tanlang",
            allLessons: "Barcha darslar",
            lessonPrefix: "Dars",
            question: "Savol",
            score: "Hisob",
            nextBtn: "Keyingi",
            wait: "Kuting",
            grammarLabel: "Grammatika",
            correct: "To'g'ri!",
            incorrect: "Xato",
            correctAnswerIs: "To'g'ri javob:",
            results: "Natijalar",
            mainMenu: "Bosh menyu",
            mistakesTitle: "Xatolar:",
            scoreLabel: "To'g'ri javoblar",
            login: "Kirish",
            register: "Ro'yxatdan o'tish",
            name: "Ism",
            email: "Email",
            password: "Parol",
            loginBtn: "Kirish",
            registerBtn: "Hisob yaratish",
            logout: "Chiqish",
            errEmailRequired: "Email kiriting",
            errPasswordRequired: "Parol kiriting (kamida 6 belgi)",
            errNameRequired: "Ismingizni kiriting",
            errInvalidCreds: "Noto'g'ri email yoki parol",
            errEmailTaken: "Bu email allaqachon ro'yxatdan o'tgan",
            errGeneric: "Xatolik yuz berdi. Qaytadan urinib ko'ring.",
            leaderboardTitle: "O'quvchilar reytingi",
            leaderboardEmpty: "Hozircha ma'lumot yo'q. So'z o'rganishni boshlang!",
            leaderboardOffline: "Reyting faqat onlayn rejimda ishlaydi",
            back: "Ortga",
            wordsLabel: "so'z",
            dictionary: "Lug'at",
            wordsCount: "so'z",
            examples: "Misollar",
            grammarNote: "Grammatika"
        }
    };

    // ============================================
    // STATE
    // ============================================
    var state = {
        lang: 'ru',
        quizData: [],
        currentOptions: [],
        currentIndex: 0,
        score: 0,
        mistakes: [],
        isModalOpen: false,
        timerInterval: null,
        user: null,
        userProgress: {},
        authMode: 'login',
        soundEnabled: true,
        currentLessonFilter: null
    };

    // ============================================
    // DOM REFS
    // ============================================
    var els = {};

    function cacheDom() {
        els.title = document.getElementById('app-title');
        els.langBtns = document.querySelectorAll('.lang-btn');

        els.authScreen = document.getElementById('auth-screen');
        els.startScreen = document.getElementById('start-screen');
        els.quizView = document.getElementById('quiz-view');
        els.resultsView = document.getElementById('results-view');
        els.leaderboardScreen = document.getElementById('leaderboard-screen');
        els.dictionaryScreen = document.getElementById('dictionary-screen');

        els.headerUserInfo = document.getElementById('header-user-info');
        els.headerUserName = document.getElementById('header-user-name');
        els.soundToggleBtn = document.getElementById('sound-toggle-btn');
        els.leaderboardBtn = document.getElementById('leaderboard-btn');
        els.dictionaryBtn = document.getElementById('dictionary-btn');
        els.logoutBtn = document.getElementById('logout-btn');

        els.tabLogin = document.getElementById('tab-login');
        els.tabRegister = document.getElementById('tab-register');
        els.fieldName = document.getElementById('field-name');
        els.authName = document.getElementById('auth-name');
        els.authEmail = document.getElementById('auth-email');
        els.authPassword = document.getElementById('auth-password');
        els.authError = document.getElementById('auth-error');
        els.authSubmitBtn = document.getElementById('auth-submit-btn');
        els.authLabelName = document.getElementById('auth-label-name');
        els.authLabelEmail = document.getElementById('auth-label-email');
        els.authLabelPassword = document.getElementById('auth-label-password');

        els.selectLessonTitle = document.getElementById('select-lesson-title');
        els.lessonGrid = document.getElementById('lesson-grid');

        els.quizProgressBar = document.getElementById('quiz-progress-bar');
        els.labelQ = document.getElementById('label-q');
        els.labelScore = document.getElementById('label-score');
        els.progressText = document.getElementById('progress-text');
        els.currentScoreDisplay = document.getElementById('current-score-display');
        els.wordDisplay = document.getElementById('word-display');
        els.lessonIndicator = document.getElementById('lesson-indicator');
        els.optionsContainer = document.getElementById('options-container');

        els.modal = document.getElementById('feedback-modal');
        els.feedbackIcon = document.getElementById('feedback-icon');
        els.feedbackStatus = document.getElementById('feedback-status');
        els.correctLabel = document.getElementById('correct-label');
        els.correctAnswerText = document.getElementById('correct-answer-text');
        els.modalExampleJp = document.getElementById('modal-example-jp');
        els.modalExampleTrans = document.getElementById('modal-example-trans');
        els.modalGrammarLabel = document.getElementById('modal-grammar-label');
        els.modalGrammarText = document.getElementById('modal-grammar-text');
        els.modalNextBtn = document.getElementById('modal-next-btn');
        els.btnText = document.getElementById('btn-text');
        els.timerBar = document.getElementById('timer-bar');

        els.resultsTitle = document.getElementById('results-title');
        els.finalScore = document.getElementById('final-score');
        els.finalScoreLabel = document.getElementById('final-score-label');
        els.mistakesTitle = document.getElementById('mistakes-title');
        els.mistakesList = document.getElementById('mistakes-list');
        els.mistakesBlock = document.getElementById('mistakes-block');
        els.restartBtn = document.getElementById('restart-btn');
        els.quizBackBtn = document.getElementById('quiz-back-btn');

        els.leaderboardTitle = document.getElementById('leaderboard-title');
        els.leaderboardList = document.getElementById('leaderboard-list');
        els.leaderboardBackBtn = document.getElementById('leaderboard-back-btn');

        els.dictionaryTitle = document.getElementById('dictionary-title');
        els.dictionaryBreadcrumb = document.getElementById('dictionary-breadcrumb');
        els.dictionaryContent = document.getElementById('dictionary-content');
        els.dictionaryBackBtn = document.getElementById('dictionary-back-btn');

        els.sakuraContainer = document.getElementById('sakura-container');
        els.sakuraToggle = document.getElementById('sakura-toggle');
        els.themeToggleBtn = document.getElementById('theme-toggle-btn');
    }

    // ============================================
    // THEME
    // ============================================
    function initTheme() {
        var saved = null;
        try { saved = localStorage.getItem('mnn_theme'); } catch(e) {}
        if (saved === 'dark') {
            document.documentElement.setAttribute('data-theme', 'dark');
        }
    }

    function toggleTheme() {
        var isDark = document.documentElement.getAttribute('data-theme') === 'dark';
        if (isDark) {
            document.documentElement.removeAttribute('data-theme');
            try { localStorage.setItem('mnn_theme', 'light'); } catch(e) {}
        } else {
            document.documentElement.setAttribute('data-theme', 'dark');
            try { localStorage.setItem('mnn_theme', 'dark'); } catch(e) {}
        }
    }

    // ============================================
    // SOUND (Web Audio API)
    // ============================================
    var audioCtx = null;
    function getAudioCtx() {
        if (!audioCtx) {
            try { audioCtx = new (window.AudioContext || window.webkitAudioContext)(); } catch(e) {}
        }
        return audioCtx;
    }

    function playCorrectSound() {
        if (!state.soundEnabled) return;
        try {
            var ctx = getAudioCtx(); if (!ctx) return;
            var osc = ctx.createOscillator();
            var gain = ctx.createGain();
            osc.connect(gain); gain.connect(ctx.destination);
            osc.type = 'sine';
            osc.frequency.setValueAtTime(523.25, ctx.currentTime);
            osc.frequency.setValueAtTime(659.25, ctx.currentTime + 0.1);
            osc.frequency.setValueAtTime(783.99, ctx.currentTime + 0.2);
            gain.gain.setValueAtTime(0.15, ctx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.4);
            osc.start(ctx.currentTime); osc.stop(ctx.currentTime + 0.4);
        } catch(e) {}
    }

    function playIncorrectSound() {
        if (!state.soundEnabled) return;
        try {
            var ctx = getAudioCtx(); if (!ctx) return;
            var osc = ctx.createOscillator();
            var gain = ctx.createGain();
            osc.connect(gain); gain.connect(ctx.destination);
            osc.type = 'sine';
            osc.frequency.setValueAtTime(349.23, ctx.currentTime);
            osc.frequency.setValueAtTime(311.13, ctx.currentTime + 0.15);
            gain.gain.setValueAtTime(0.15, ctx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.35);
            osc.start(ctx.currentTime); osc.stop(ctx.currentTime + 0.35);
        } catch(e) {}
    }

    // ============================================
    // LOCAL STORAGE PROGRESS (offline fallback)
    // ============================================
    var LS_KEY = 'mnn_progress';

    function loadLocalProgress() {
        try {
            var data = localStorage.getItem(LS_KEY);
            if (data) {
                state.userProgress = JSON.parse(data);
            }
        } catch(e) {
            state.userProgress = {};
        }
    }

    function saveLocalProgress() {
        try {
            localStorage.setItem(LS_KEY, JSON.stringify(state.userProgress));
        } catch(e) {}
    }

    // ============================================
    // NAVIGATION
    // ============================================
    function showScreen(name) {
        els.authScreen.classList.remove('visible');
        els.startScreen.classList.remove('visible');
        els.quizView.classList.remove('visible');
        els.resultsView.classList.remove('visible');
        els.leaderboardScreen.classList.remove('visible');
        els.dictionaryScreen.classList.remove('visible');

        var map = {
            auth: els.authScreen,
            start: els.startScreen,
            quiz: els.quizView,
            results: els.resultsView,
            leaderboard: els.leaderboardScreen,
            dictionary: els.dictionaryScreen
        };
        if (map[name]) map[name].classList.add('visible');
    }

    // ============================================
    // HEADER VISIBILITY
    // ============================================
    function showHeaderButtons(show) {
        var method = show ? 'add' : 'remove';
        els.soundToggleBtn.classList[method]('visible');
        els.leaderboardBtn.classList[method]('visible');
        els.dictionaryBtn.classList[method]('visible');
        els.logoutBtn.classList[method]('visible');
        els.headerUserInfo.style.display = show ? 'flex' : 'none';
    }

    // ============================================
    // AUTH
    // ============================================
    function switchAuthMode(mode) {
        state.authMode = mode;
        els.tabLogin.classList.toggle('active', mode === 'login');
        els.tabRegister.classList.toggle('active', mode === 'register');
        els.fieldName.style.display = mode === 'register' ? 'flex' : 'none';
        els.authError.textContent = '';
        updateAuthLabels();
    }

    function updateAuthLabels() {
        var txt = uiTexts[state.lang];
        els.tabLogin.textContent = txt.login;
        els.tabRegister.textContent = txt.register;
        els.authLabelName.textContent = txt.name;
        els.authLabelEmail.textContent = txt.email;
        els.authLabelPassword.textContent = txt.password;
        els.authSubmitBtn.textContent = state.authMode === 'login' ? txt.loginBtn : txt.registerBtn;
    }

    var _authAttempts = 0;
    var _authLockUntil = 0;
    var AUTH_MAX_ATTEMPTS = 5;
    var AUTH_LOCK_MS = 30000; // 30 seconds cooldown

    async function handleAuthSubmit() {
        if (!supabaseReady) return;

        var now = Date.now();
        if (now < _authLockUntil) {
            var secsLeft = Math.ceil((_authLockUntil - now) / 1000);
            els.authError.textContent = uiTexts[state.lang].wait + ' (' + secsLeft + 's)';
            return;
        }

        var txt = uiTexts[state.lang];
        var email = els.authEmail.value.trim();
        var password = els.authPassword.value;
        var name = els.authName.value.trim();

        els.authEmail.classList.remove('error');
        els.authPassword.classList.remove('error');
        els.authName.classList.remove('error');

        if (!email) {
            els.authEmail.classList.add('error');
            els.authError.textContent = txt.errEmailRequired;
            return;
        }
        if (!password || password.length < 6) {
            els.authPassword.classList.add('error');
            els.authError.textContent = txt.errPasswordRequired;
            return;
        }
        if (state.authMode === 'register' && !name) {
            els.authName.classList.add('error');
            els.authError.textContent = txt.errNameRequired;
            return;
        }

        els.authSubmitBtn.disabled = true;
        var btnLabel = state.authMode === 'login' ? txt.loginBtn : txt.registerBtn;
        els.authSubmitBtn.innerHTML = '<span class="spinner"></span>' + btnLabel;
        els.authError.textContent = '';

        try {
            var result;
            if (state.authMode === 'login') {
                result = await sb.auth.signInWithPassword({ email: email, password: password });
            } else {
                result = await sb.auth.signUp({
                    email: email,
                    password: password,
                    options: { data: { display_name: name } }
                });
            }

            if (result.error) {
                _authAttempts++;
                if (_authAttempts >= AUTH_MAX_ATTEMPTS) {
                    _authLockUntil = Date.now() + AUTH_LOCK_MS;
                    _authAttempts = 0;
                }
                var msg = result.error.message || '';
                if (msg.indexOf('Invalid login') !== -1) {
                    els.authError.textContent = txt.errInvalidCreds;
                } else if (msg.indexOf('already registered') !== -1 || msg.indexOf('already been registered') !== -1) {
                    els.authError.textContent = txt.errEmailTaken;
                } else {
                    els.authError.textContent = msg || txt.errGeneric;
                }
                return;
            }

            state.user = (result.data.user) || (result.data.session && result.data.session.user);
            _authAttempts = 0;
            _authLockUntil = 0;
            await onAuthSuccess();
        } catch (err) {
            els.authError.textContent = txt.errGeneric;
        } finally {
            els.authSubmitBtn.disabled = false;
            updateAuthLabels();
        }
    }

    async function onAuthSuccess() {
        showHeaderButtons(true);

        var displayName = 'User';
        try {
            var res = await sb.from('profiles').select('display_name').eq('id', state.user.id).single();
            if (res.data && res.data.display_name) displayName = res.data.display_name;
            else if (state.user.user_metadata && state.user.user_metadata.display_name) displayName = state.user.user_metadata.display_name;
        } catch(e) {
            if (state.user.user_metadata && state.user.user_metadata.display_name) displayName = state.user.user_metadata.display_name;
        }
        els.headerUserName.textContent = displayName;

        await loadSupabaseProgress();
        initLessonSelection();
    }

    async function handleLogout() {
        if (supabaseReady && sb) {
            try { await sb.auth.signOut(); } catch(e) {}
        }
        state.user = null;
        state.userProgress = {};
        showHeaderButtons(false);
        if (supabaseReady) {
            showScreen('auth');
        } else {
            loadLocalProgress();
            initLessonSelection();
        }
    }

    // ============================================
    // PROGRESS: SUPABASE
    // ============================================
    async function loadSupabaseProgress() {
        if (!supabaseReady || !state.user) return;
        try {
            var res = await sb.from('word_progress')
                .select('word_id, correct_count, lesson_number')
                .eq('user_id', state.user.id);

            state.userProgress = {};
            if (res.data) {
                res.data.forEach(function(row) {
                    state.userProgress[row.word_id] = {
                        correct_count: row.correct_count,
                        lesson_number: row.lesson_number
                    };
                });
            }
        } catch (e) {
            // Silently fail â€” progress will use local fallback
        }
    }

    async function saveAnswer(wordData, isCorrect) {
        if (!state.userProgress[wordData.id]) {
            state.userProgress[wordData.id] = { correct_count: 0, lesson_number: wordData.lesson };
        }
        if (isCorrect) {
            state.userProgress[wordData.id].correct_count++;
        }

        if (supabaseReady && state.user) {
            try {
                await sb.rpc('upsert_word_progress', {
                    p_user_id: state.user.id,
                    p_word_id: wordData.id,
                    p_lesson_number: wordData.lesson,
                    p_is_correct: isCorrect
                });
            } catch (e) {
                // Save failed silently â€” local progress already updated
            }
        }

        saveLocalProgress();
    }

    // ============================================
    // PROGRESS CALCULATIONS
    // ============================================
    // Pre-index words by lesson for O(1) lookups instead of repeated .filter()
    var _wordsByLesson = {};
    wordsData.forEach(function(w) {
        if (!_wordsByLesson[w.lesson]) _wordsByLesson[w.lesson] = [];
        _wordsByLesson[w.lesson].push(w);
    });

    function getWordsByLesson(lessonNum) {
        return _wordsByLesson[lessonNum] || [];
    }

    function getLessonProgress(lessonNum) {
        var lessonWords = getWordsByLesson(lessonNum);
        var total = lessonWords.length;
        var mastered = 0;
        lessonWords.forEach(function(w) {
            var p = state.userProgress[w.id];
            if (p && p.correct_count >= MASTERY_THRESHOLD) mastered++;
        });
        return { mastered: mastered, total: total, percent: total > 0 ? Math.min(100, Math.max(0, Math.round((mastered / total) * 100))) : 0 };
    }

    function getProgressColor(percent) {
        if (percent <= 33) return 'low';
        if (percent <= 66) return 'mid';
        return 'high';
    }

    // ============================================
    // LESSON SELECTION
    // ============================================
    function initLessonSelection() {
        if (state.timerInterval) clearInterval(state.timerInterval);
        showScreen('start');
        renderLessonGrid();
        updateUILabels();
    }

    var _cachedLessons = null;
    function getAvailableLessons() {
        if (_cachedLessons) return _cachedLessons;
        var lessonsSet = {};
        wordsData.forEach(function(w) { lessonsSet[w.lesson] = true; });
        _cachedLessons = Object.keys(lessonsSet).map(Number).sort(function(a,b) { return a - b; });
        return _cachedLessons;
    }

    function renderLessonGrid() {
        els.lessonGrid.innerHTML = '';
        var lessons = getAvailableLessons();
        var txt = uiTexts[state.lang];

        var allBtn = document.createElement('button');
        allBtn.className = 'lesson-btn all-lessons';
        allBtn.innerHTML = ICONS.layers + '<span class="lesson-btn-name">' + txt.allLessons + '</span>';
        allBtn.onclick = function() { startQuiz(null); };
        els.lessonGrid.appendChild(allBtn);

        lessons.forEach(function(lessonNum) {
            var prog = getLessonProgress(lessonNum);
            var colorClass = getProgressColor(prog.percent);

            var btn = document.createElement('button');
            btn.className = 'lesson-btn';
            btn.innerHTML =
                '<span class="lesson-btn-name">' + txt.lessonPrefix + ' ' + lessonNum + '</span>' +
                '<div class="lesson-progress-wrap">' +
                    '<div class="lesson-progress-track">' +
                        '<div class="lesson-progress-fill ' + colorClass + '" style="width:' + prog.percent + '%"></div>' +
                    '</div>' +
                    '<span class="lesson-progress-text">' + prog.mastered + ' / ' + prog.total + ' ' + txt.wordsLabel + '</span>' +
                '</div>';
            btn.onclick = (function(num) { return function() { startQuiz(num); }; })(lessonNum);
            els.lessonGrid.appendChild(btn);
        });
    }

    // ============================================
    // QUIZ
    // ============================================
    function startQuiz(lessonFilter) {
        if (state.timerInterval) clearInterval(state.timerInterval);

        state.currentIndex = 0;
        state.score = 0;
        state.mistakes = [];
        state.isModalOpen = false;
        state.currentLessonFilter = lessonFilter;

        var filteredData = wordsData;
        if (lessonFilter !== null) {
            filteredData = wordsData.filter(function(w) { return w.lesson === lessonFilter; });
        }
        state.quizData = shuffleArray(filteredData.slice());

        showScreen('quiz');
        renderQuestion(true);
        updateUILabels();
    }

    function setLanguage(lang) {
        state.lang = lang;
        els.langBtns.forEach(function(btn) {
            btn.classList.toggle('active', btn.dataset.lang === lang);
        });
        updateUILabels();
        updateAuthLabels();

        if (els.startScreen.classList.contains('visible')) {
            renderLessonGrid();
        } else if (els.quizView.classList.contains('visible')) {
            renderQuestion(false);
            if (state.isModalOpen && state.currentIndex < state.quizData.length) {
                updateModalContent(state.quizData[state.currentIndex]);
            }
        } else if (els.resultsView.classList.contains('visible')) {
            showResults();
        } else if (els.leaderboardScreen.classList.contains('visible')) {
            showLeaderboard();
        } else if (els.dictionaryScreen.classList.contains('visible')) {
            updateUILabels();
            if (dictState.view === 'lessons') renderDictLessons();
            else if (dictState.view === 'words') renderDictWords(dictState.lessonNum);
            else if (dictState.view === 'detail') renderDictWordDetail(dictState.wordId);
        }
    }

    function updateUILabels() {
        var txt = uiTexts[state.lang];
        els.selectLessonTitle.innerText = txt.selectLesson;
        els.labelQ.innerText = txt.question;
        els.labelScore.innerText = txt.score;
        els.correctLabel.innerText = txt.correctAnswerIs;
        els.resultsTitle.innerText = txt.results;
        els.finalScoreLabel.innerText = txt.scoreLabel;
        els.restartBtn.innerText = txt.mainMenu;
        els.leaderboardBackBtn.innerText = txt.back;
        els.dictionaryBackBtn.innerText = txt.back;
        els.quizBackBtn.innerText = txt.back;

        if (!els.modalNextBtn.disabled) {
            els.btnText.innerText = txt.nextBtn;
        }
    }

    function shuffleArray(array) {
        for (var i = array.length - 1; i > 0; i--) {
            var j = Math.floor(Math.random() * (i + 1));
            var temp = array[i];
            array[i] = array[j];
            array[j] = temp;
        }
        return array;
    }

    function getSmartDistractors(currentWord) {
        var sameLessonWords = getWordsByLesson(currentWord.lesson).filter(function(w) {
            return w.id !== currentWord.id;
        });

        if (sameLessonWords.length >= 3) {
            return shuffleArray(sameLessonWords.slice()).slice(0, 3);
        }

        var currentLesson = currentWord.lesson;
        var neighborWords = wordsData.filter(function(w) {
            return w.id !== currentWord.id && Math.abs(w.lesson - currentLesson) <= 2;
        });

        if (neighborWords.length >= 3) {
            return shuffleArray(neighborWords.slice()).slice(0, 3);
        }

        return shuffleArray(wordsData.filter(function(w) { return w.id !== currentWord.id; })).slice(0, 3);
    }

    function renderQuestion(randomize) {
        if (state.currentIndex >= state.quizData.length || state.quizData.length === 0) return;

        var currentWord = state.quizData[state.currentIndex];
        var txt = uiTexts[state.lang];

        els.progressText.innerText = (state.currentIndex + 1) + ' / ' + state.quizData.length;
        els.currentScoreDisplay.innerText = state.score;
        els.currentScoreDisplay.classList.remove('bump');
        void els.currentScoreDisplay.offsetWidth;
        els.lessonIndicator.innerText = txt.lessonPrefix + ' ' + currentWord.lesson;
        els.wordDisplay.innerHTML = currentWord.japanese;
        
        // Re-trigger word reveal animation
        els.wordDisplay.style.animation = 'none';
        void els.wordDisplay.offsetWidth;
        els.wordDisplay.style.animation = 'wordReveal 0.6s cubic-bezier(0.16, 1, 0.3, 1) both';

        var progressPercent = (state.currentIndex / state.quizData.length) * 100;
        els.quizProgressBar.style.width = progressPercent + '%';

        els.optionsContainer.classList.remove('locked');

        if (randomize) {
            var distractors = getSmartDistractors(currentWord);

            var options = [
                { id: currentWord.id, text: currentWord.translations, isCorrect: true }
            ];
            distractors.forEach(function(w) {
                options.push({ id: w.id, text: w.translations, isCorrect: false });
            });
            state.currentOptions = shuffleArray(options);
        }

        els.optionsContainer.innerHTML = '';
        state.currentOptions.forEach(function(opt) {
            var btn = document.createElement('button');
            btn.className = 'option-btn';
            btn.innerText = opt.text[state.lang];
            btn.onclick = function() { handleAnswer(opt.isCorrect, btn, currentWord); };
            els.optionsContainer.appendChild(btn);
        });
    }

    function handleAnswer(isCorrect, btnElement, currentWord) {
        els.optionsContainer.classList.add('locked');

        var allBtns = els.optionsContainer.querySelectorAll('.option-btn');
        allBtns.forEach(function(b) { b.disabled = true; });

        saveAnswer(currentWord, isCorrect);

        if (isCorrect) {
            state.score++;
            btnElement.classList.add('correct');
            els.currentScoreDisplay.innerText = state.score;
            els.currentScoreDisplay.classList.add('bump');
            playCorrectSound();
            var rect = btnElement.getBoundingClientRect();
            spawnConfetti(rect.left + rect.width / 2, rect.top + rect.height / 2);
            setTimeout(function() { openModal(true, currentWord); }, 500);
        } else {
            state.mistakes.push(currentWord);
            btnElement.classList.add('incorrect');
            playIncorrectSound();

            allBtns.forEach(function(b, idx) {
                if (state.currentOptions[idx].isCorrect) {
                    b.classList.add('correct');
                }
            });

            setTimeout(function() { openModal(false, currentWord); }, 800);
        }
    }

    function openModal(isCorrect, wordData) {
        state.isModalOpen = true;
        var txt = uiTexts[state.lang];

        if (isCorrect) {
            els.feedbackIcon.innerHTML = ICONS.check;
            els.feedbackIcon.className = 'result-icon correct';
            els.feedbackStatus.innerText = txt.correct;
            els.feedbackStatus.className = 'result-title correct';
        } else {
            els.feedbackIcon.innerHTML = ICONS.x;
            els.feedbackIcon.className = 'result-icon incorrect';
            els.feedbackStatus.innerText = txt.incorrect;
            els.feedbackStatus.className = 'result-title incorrect';
        }

        updateModalContent(wordData);
        els.modal.querySelector('.modal-content').scrollTop = 0;
        els.modal.classList.add('visible');
        startTimer();
    }

    function updateModalContent(wordData) {
        var ex = wordData.exampleSentences ? wordData.exampleSentences[state.lang] : null;
        els.correctAnswerText.innerText = wordData.translations[state.lang] || '';
        if (ex) {
            els.modalExampleJp.innerHTML = ex.jp || '';
            els.modalExampleTrans.innerText = ex.translation || '';
            els.modalGrammarText.innerText = ex.grammarInfo || '';
        } else {
            els.modalExampleJp.innerHTML = '';
            els.modalExampleTrans.innerText = '';
            els.modalGrammarText.innerText = '';
        }
    }

    function startTimer() {
        if (state.timerInterval) clearInterval(state.timerInterval);

        var timeLeft = 3;
        var totalTime = 3;
        var txt = uiTexts[state.lang];

        els.modalNextBtn.disabled = true;
        els.modalNextBtn.classList.add('counting');
        els.btnText.innerText = txt.nextBtn + ' (' + timeLeft + ')';

        els.timerBar.style.transition = 'none';
        els.timerBar.style.width = '100%';
        void els.timerBar.offsetWidth;
        els.timerBar.style.transition = 'width ' + totalTime + 's linear';
        els.timerBar.style.width = '0%';

        state.timerInterval = setInterval(function() {
            timeLeft--;
            if (timeLeft > 0) {
                var currentTxt = uiTexts[state.lang];
                els.btnText.innerText = currentTxt.nextBtn + ' (' + timeLeft + ')';
            } else {
                clearInterval(state.timerInterval);
                state.timerInterval = null;
                var currentTxt = uiTexts[state.lang];
                els.modalNextBtn.disabled = false;
                els.modalNextBtn.classList.remove('counting');
                els.btnText.innerText = currentTxt.nextBtn;
            }
        }, 1000);
    }

    function nextQuestion() {
        state.isModalOpen = false;
        els.modal.classList.remove('visible');
        if (state.timerInterval) clearInterval(state.timerInterval);

        state.currentIndex++;

        if (state.currentIndex < state.quizData.length) {
            renderQuestion(true);
        } else {
            els.quizProgressBar.style.width = '100%';
            showResults();
        }
    }

    function showResults() {
        showScreen('results');
        var percentage = Math.round((state.score / state.quizData.length) * 100);
        els.finalScore.innerText = percentage + '%';

        els.mistakesList.innerHTML = '';
        if (state.mistakes.length === 0) {
            els.mistakesBlock.style.display = 'none';
        } else {
            els.mistakesBlock.style.display = 'block';
            state.mistakes.forEach(function(word) {
                var item = document.createElement('div');
                item.className = 'mistake-item';
                item.innerHTML =
                    '<div class="mistake-word">' + word.japanese + '</div>' +
                    '<div class="mistake-answer">' + escapeHtml(word.translations[state.lang]) + '</div>';
                els.mistakesList.appendChild(item);
            });
        }
    }

    // ============================================
    // LEADERBOARD
    // ============================================
    async function showLeaderboard() {
        showScreen('leaderboard');
        updateUILabels();

        var txt = uiTexts[state.lang];

        if (!supabaseReady) {
            els.leaderboardList.innerHTML = '<div class="leaderboard-empty">' + txt.leaderboardOffline + '</div>';
            return;
        }

        els.leaderboardList.innerHTML = '<div class="leaderboard-empty" style="opacity:0.5;">...</div>';

        try {
            var totalWords = wordsData.length;
            var res = await sb.rpc('get_leaderboard', {
                mastery_threshold: MASTERY_THRESHOLD,
                total_words: totalWords
            });

            if (res.error) throw res.error;

            if (!res.data || res.data.length === 0) {
                els.leaderboardList.innerHTML = '<div class="leaderboard-empty">' + txt.leaderboardEmpty + '</div>';
                return;
            }

            els.leaderboardList.innerHTML = '';
            res.data.forEach(function(row, idx) {
                var rank = idx + 1;
                var rankClass = rank === 1 ? ' gold' : rank === 2 ? ' silver' : rank === 3 ? ' bronze' : '';
                var isCurrentUser = state.user && row.user_id === state.user.id;
                var percent = Number(row.mastery_percentage) || 0;
                var colorClass = getProgressColor(percent);

                var div = document.createElement('div');
                div.className = 'leaderboard-row' + (isCurrentUser ? ' current-user' : '');
                div.innerHTML =
                    '<div class="leaderboard-rank' + rankClass + '">' + rank + '</div>' +
                    '<div class="leaderboard-info">' +
                        '<div class="leaderboard-name">' + escapeHtml(row.display_name) + '</div>' +
                        '<div class="leaderboard-stats">' +
                            '<div class="leaderboard-bar-track">' +
                                '<div class="leaderboard-bar-fill ' + colorClass + '" style="width:' + percent + '%"></div>' +
                            '</div>' +
                            '<span class="leaderboard-percent">' + percent + '%</span>' +
                        '</div>' +
                    '</div>';
                els.leaderboardList.appendChild(div);
            });
        } catch (e) {
            els.leaderboardList.innerHTML = '<div class="leaderboard-empty">' + txt.leaderboardEmpty + '</div>';
        }
    }

    var _escapeDiv = document.createElement('div');
    function escapeHtml(str) {
        _escapeDiv.textContent = str || '';
        return _escapeDiv.innerHTML;
    }

    // ============================================
    // SAKURA PETALS
    // ============================================
    var sakuraEnabled = true;

    function createSakuraPetals() {
        var container = els.sakuraContainer;
        var isMobile = window.innerWidth <= 480;
        var count = isMobile ? 10 : 16;

        container.innerHTML = '';

        for (var i = 0; i < count; i++) {
            var petal = document.createElement('div');
            petal.className = 'sakura-petal';
            petal.textContent = 'ðŸŒ¸';

            var sizes = [12, 14, 16, 18, 20];
            var size = sizes[Math.floor(Math.random() * sizes.length)];
            var left = Math.random() * 100;
            var fallDuration = 12 + Math.random() * 14;
            var swayDuration = 4 + Math.random() * 5;
            var delay = Math.random() * 16;
            var opacity = 0.15 + Math.random() * 0.25;

            petal.style.cssText =
                'left:' + left + '%;' +
                'font-size:' + size + 'px;' +
                'opacity:' + opacity + ';' +
                'animation-duration:' + fallDuration + 's,' + swayDuration + 's;' +
                'animation-delay:' + delay + 's,' + delay + 's;';

            container.appendChild(petal);
        }
    }

    // ---- Confetti burst on correct answer ----
    function spawnConfetti(x, y) {
        var container = document.createElement('div');
        container.className = 'confetti-container';
        document.body.appendChild(container);
        var colors = ['#5a9e6f', '#7bc48d', '#c4736e', '#d4908f', '#c49a3c', '#d4c060', '#6ba3d4', '#a088c4'];
        for (var i = 0; i < 24; i++) {
            var p = document.createElement('div');
            p.className = 'confetti-particle';
            var angle = (Math.PI * 2 / 24) * i + (Math.random() - 0.5) * 0.5;
            var dist = 60 + Math.random() * 100;
            var tx = Math.cos(angle) * dist;
            var ty = Math.sin(angle) * dist - 30;
            var tr = (Math.random() * 720 - 360) + 'deg';
            p.style.cssText =
                'left:' + x + 'px;top:' + y + 'px;' +
                'background:' + colors[Math.floor(Math.random() * colors.length)] + ';' +
                '--tx:' + tx + 'px;--ty:' + ty + 'px;--tr:' + tr + ';' +
                'width:' + (5 + Math.random() * 5) + 'px;' +
                'height:' + (5 + Math.random() * 5) + 'px;' +
                'border-radius:' + (Math.random() > 0.5 ? '50%' : '2px') + ';' +
                'animation-duration:' + (0.7 + Math.random() * 0.5) + 's;' +
                'animation-delay:' + (Math.random() * 0.1) + 's;';
            container.appendChild(p);
        }
        setTimeout(function() { container.remove(); }, 1500);
    }

    function toggleSakura() {
        sakuraEnabled = !sakuraEnabled;
        els.sakuraContainer.style.display = sakuraEnabled ? '' : 'none';
        els.sakuraToggle.classList.toggle('off', !sakuraEnabled);
    }

    // ============================================
    // DICTIONARY
    // ============================================
    var dictState = { view: 'lessons', lessonNum: null, wordId: null };

    function showDictionary() {
        dictState = { view: 'lessons', lessonNum: null, wordId: null };
        showScreen('dictionary');
        updateUILabels();
        renderDictLessons();
    }

    function dictGoToLesson(lessonNum) {
        dictState.view = 'words';
        dictState.lessonNum = lessonNum;
        dictState.wordId = null;
        renderDictWords(lessonNum);
    }

    function dictGoToWord(wordId) {
        dictState.view = 'detail';
        dictState.wordId = wordId;
        renderDictWordDetail(wordId);
    }

    function dictGoBack() {
        if (dictState.view === 'detail') {
            dictGoToLesson(dictState.lessonNum);
        } else if (dictState.view === 'words') {
            dictState.view = 'lessons';
            dictState.lessonNum = null;
            renderDictLessons();
        } else {
            initLessonSelection();
        }
    }

    function renderDictBreadcrumb() {
        var txt = uiTexts[state.lang];
        var bc = els.dictionaryBreadcrumb;
        bc.innerHTML = '';

        var root = document.createElement('span');
        if (dictState.view !== 'lessons') {
            root.className = 'dict-breadcrumb-link';
            root.textContent = txt.dictionary;
            root.onclick = function() {
                dictState.view = 'lessons';
                dictState.lessonNum = null;
                dictState.wordId = null;
                renderDictLessons();
            };
        } else {
            root.className = 'dict-breadcrumb-current';
            root.textContent = txt.dictionary;
        }
        bc.appendChild(root);

        if (dictState.view === 'words' || dictState.view === 'detail') {
            var sep1 = document.createElement('span');
            sep1.className = 'dict-breadcrumb-sep';
            sep1.textContent = 'â€º';
            bc.appendChild(sep1);

            var lessonLink = document.createElement('span');
            lessonLink.textContent = txt.lessonPrefix + ' ' + dictState.lessonNum;
            if (dictState.view === 'detail') {
                lessonLink.className = 'dict-breadcrumb-link';
                lessonLink.onclick = function() { dictGoToLesson(dictState.lessonNum); };
            } else {
                lessonLink.className = 'dict-breadcrumb-current';
            }
            bc.appendChild(lessonLink);
        }

        if (dictState.view === 'detail') {
            var word = wordsData.find(function(w) { return w.id === dictState.wordId; });
            if (word) {
                var sep2 = document.createElement('span');
                sep2.className = 'dict-breadcrumb-sep';
                sep2.textContent = 'â€º';
                bc.appendChild(sep2);

                var wordLabel = document.createElement('span');
                wordLabel.className = 'dict-breadcrumb-current';
                wordLabel.textContent = word.cleanWord;
                bc.appendChild(wordLabel);
            }
        }
    }

    function renderDictLessons() {
        var txt = uiTexts[state.lang];
        renderDictBreadcrumb();

        var container = els.dictionaryContent;
        container.innerHTML = '';

        var grid = document.createElement('div');
        grid.className = 'dict-lesson-grid';

        var lessons = getAvailableLessons();

        lessons.forEach(function(lessonNum) {
            var lessonWords = getWordsByLesson(lessonNum);

            var btn = document.createElement('button');
            btn.className = 'dict-lesson-btn';
            btn.innerHTML =
                '<span class="dict-lesson-icon">' + ICONS.book + '</span>' +
                '<span>' + txt.lessonPrefix + ' ' + lessonNum + '</span>' +
                '<span class="dict-lesson-count">' + lessonWords.length + ' ' + txt.wordsCount + '</span>';
            btn.onclick = (function(num) { return function() { dictGoToLesson(num); }; })(lessonNum);
            grid.appendChild(btn);
        });

        container.appendChild(grid);
    }

    function renderDictWords(lessonNum) {
        var txt = uiTexts[state.lang];
        renderDictBreadcrumb();

        var container = els.dictionaryContent;
        container.innerHTML = '';

        var list = document.createElement('div');
        list.className = 'dict-words-list';

        var lessonWords = getWordsByLesson(lessonNum);

        lessonWords.forEach(function(word) {
            var card = document.createElement('div');
            card.className = 'dict-word-card';
            card.innerHTML =
                '<div>' +
                    '<div class="dict-word-jp">' + word.japanese + '</div>' +
                    '<div class="dict-word-trans">' + escapeHtml(word.translations[state.lang]) + '</div>' +
                '</div>' +
                '<span class="dict-word-arrow">' + ICONS.chevronRight + '</span>';
            card.onclick = (function(id) { return function() { dictGoToWord(id); }; })(word.id);
            list.appendChild(card);
        });

        container.appendChild(list);
        container.style.animation = 'none';
        void container.offsetWidth;
        container.style.animation = 'fadeInUp 0.35s ease-out';
    }

    function renderDictWordDetail(wordId) {
        var txt = uiTexts[state.lang];
        renderDictBreadcrumb();

        var word = wordsData.find(function(w) { return w.id === wordId; });
        if (!word) return;

        var container = els.dictionaryContent;
        container.innerHTML = '';

        var header = document.createElement('div');
        header.className = 'dict-detail-header';
        header.innerHTML =
            '<div class="dict-detail-jp">' + word.japanese + '</div>' +
            '<div class="dict-detail-trans">' + escapeHtml(word.translations[state.lang]) + '</div>';
        container.appendChild(header);

        var examples = word.dictionaryExamples ? word.dictionaryExamples[state.lang] : null;
        if (examples && examples.length > 0) {
            var exLabel = document.createElement('div');
            exLabel.className = 'dict-examples-label';
            exLabel.textContent = txt.examples;
            container.appendChild(exLabel);

            examples.forEach(function(ex) {
                var item = document.createElement('div');
                item.className = 'dict-example-item';
                item.innerHTML =
                    '<div class="dict-example-jp">' + ex.jp + '</div>' +
                    '<div class="dict-example-trans">' + ex.translation + '</div>';
                container.appendChild(item);
            });
        }

        var exSentence = word.exampleSentences[state.lang];
        if (exSentence && exSentence.grammarInfo) {
            var gramDiv = document.createElement('div');
            gramDiv.className = 'dict-grammar-note';
            gramDiv.innerHTML =
                '<div class="dict-grammar-label">' + ICONS.lightbulb + ' ' + txt.grammarNote + '</div>' +
                '<div class="dict-grammar-text">' + escapeHtml(exSentence.grammarInfo) + '</div>';
            container.appendChild(gramDiv);
        }

        container.style.animation = 'none';
        void container.offsetWidth;
        container.style.animation = 'fadeInUp 0.35s ease-out';
    }

    // ============================================
    // INIT
    // ============================================
    function bootApp() {
        initTheme();
        cacheDom();

        // Event listeners
        els.langBtns.forEach(function(btn) {
            btn.addEventListener('click', function(e) { setLanguage(e.target.dataset.lang); });
        });
        els.modalNextBtn.addEventListener('click', nextQuestion);
        els.restartBtn.addEventListener('click', function() { initLessonSelection(); });
        els.quizBackBtn.addEventListener('click', function() {
            if (state.timerInterval) clearInterval(state.timerInterval);
            state.isModalOpen = false;
            els.modal.classList.remove('visible');
            initLessonSelection();
        });
        els.logoutBtn.addEventListener('click', handleLogout);
        els.leaderboardBtn.addEventListener('click', showLeaderboard);
        els.leaderboardBackBtn.addEventListener('click', function() { initLessonSelection(); });
        els.dictionaryBtn.addEventListener('click', showDictionary);
        els.dictionaryBackBtn.addEventListener('click', dictGoBack);
        els.sakuraToggle.addEventListener('click', toggleSakura);
        els.themeToggleBtn.addEventListener('click', toggleTheme);

        els.soundToggleBtn.addEventListener('click', function() {
            state.soundEnabled = !state.soundEnabled;
            els.soundToggleBtn.innerHTML = state.soundEnabled ? ICONS.volumeOn : ICONS.volumeOff;
            els.soundToggleBtn.classList.toggle('muted', !state.soundEnabled);
        });

        els.tabLogin.addEventListener('click', function() { switchAuthMode('login'); });
        els.tabRegister.addEventListener('click', function() { switchAuthMode('register'); });
        els.authSubmitBtn.addEventListener('click', handleAuthSubmit);

        els.authPassword.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') handleAuthSubmit();
        });

        els.authEmail.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') handleAuthSubmit();
        });

        els.authName.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') handleAuthSubmit();
        });

        var hasSupabase = initSupabase();

        if (hasSupabase) {
            // onAuthStateChange Ð²Ñ‹Ð·Ð¾Ð²ÐµÑ‚ INITIAL_SESSION Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸,
            // Ñ‡Ñ‚Ð¾ Ð²Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ ÑÐµÑÑÐ¸ÑŽ Ð¸Ð· localStorage Ð¿Ñ€Ð¸ F5/Ð¿ÐµÑ€ÐµÐ·Ð°Ð³Ñ€ÑƒÐ·ÐºÐµ
            // Ð¸Ð»Ð¸ Ð¿Ð¾ÐºÐ°Ð¶ÐµÑ‚ ÑÐºÑ€Ð°Ð½ Ð»Ð¾Ð³Ð¸Ð½Ð°, ÐµÑÐ»Ð¸ ÑÐµÑÑÐ¸Ð¸ Ð½ÐµÑ‚.
            setupAuthListener();
        } else {
            showHeaderButtons(false);
            els.soundToggleBtn.classList.add('visible');
            els.dictionaryBtn.classList.add('visible');
            loadLocalProgress();
            initLessonSelection();
        }

        createSakuraPetals();
    }

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', bootApp);
    } else {
        bootApp();
    }

})();
</script>
</body>
</html>
